<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ngrok Web GUI</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
        }
        .tab-button.active {
            background-color: #3498DB; /* Peter River Blue */
            color: black;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Custom scrollbar for output area */
        .custom-scrollbar::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #2C3E50; /* Dark Blue/Grey */
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #3498DB; /* Peter River Blue */
            border-radius: 10px;
            border: 3px solid #2C3E50;
        }
        .custom-scrollbar::-webkit-scrollbar-corner {
            background: #2C3E50;
        }

        /* Specific colors for Ngrok output */
        .output-green { color: #2ECC71; } /* Emerald Green */
        .output-red { color: #E74C3C; }   /* Alizarin Red */
        .output-blue { color: #3498DB; }  /* Peter River Blue */
        .output-orange { color: #F39C12; } /* Orange */
        .output-default { color: #ECF0F1; } /* Light Grey */
        .highlight { background-color: yellow; color: black; }

        /* Help popup styling */
        .help-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #2C3E50; /* Dark Blue/Grey */
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            padding: 1.5rem;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #3498DB; /* Add a border for better visibility */
        }
        .help-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 999;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8); /* Dark modal background */
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #1a202c; /* Modal background */
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            border: 1px solid #3498DB; /* Blue border for modal */
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 1px solid #3498DB;
            margin-bottom: 15px;
        }
        .modal-header h2 {
            @apply text-xl font-semibold text-blue-400; /* Blue modal title */
        }
        .modal-close {
            @apply text-gray-400 hover:text-blue-400 text-2xl font-bold;
            cursor: pointer;
        }
        .modal-body {
            flex-grow: 1;
            overflow-y: auto;
            @apply text-gray-300;
        }
        .modal-footer {
            padding-top: 15px;
            border-top: 1px solid #3498DB;
            margin-top: 15px;
            text-align: right;
        }

        /* Input field styling */
        input[type="text"], input[type="number"], select, textarea {
            @apply bg-gray-600 text-white rounded-md border border-gray-500 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 p-2;
        }
        input[type="checkbox"] {
            @apply form-checkbox h-5 w-5 text-blue-600 rounded bg-gray-600 border-gray-500;
        }

        /* Button styling */
        .btn-primary {
            @apply px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 flex items-center justify-center transition-colors duration-200;
        }
        .btn-secondary {
            @apply px-4 py-2 bg-gray-700 text-gray-200 rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50 flex items-center justify-center transition-colors duration-200;
        }
        .btn-success {
            @apply px-6 py-3 bg-green-600 text-white rounded-lg text-lg font-semibold hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 flex items-center transition-colors duration-200 transform hover:scale-105;
        }
        .btn-danger {
            @apply px-6 py-3 bg-red-600 text-white rounded-lg text-lg font-semibold hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 flex items-center transition-colors duration-200 transform hover:scale-105;
        }
        .btn-info {
            @apply px-6 py-3 bg-purple-600 text-white rounded-lg text-lg font-semibold hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50 flex items-center transition-colors duration-200 transform hover:scale-105;
        }
    </style>
</head>
<body class="p-4 min-h-screen flex flex-col items-center">
    <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-6xl mb-6">
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-3xl font-bold text-blue-400">Ngrok Web GUI</h1>
            <div class="flex space-x-2">
                <button id="install_ngrok_linux_button" class="btn-primary">
                    <i data-lucide="download" class="w-5 h-5 mr-2"></i> Install Ngrok (Linux)
                </button>
                <button id="install_ngrok_termux_button" class="btn-primary">
                    <i data-lucide="download" class="w-5 h-5 mr-2"></i> Install Ngrok (Termux)
                </button>
                <button id="download_ngrok_windows_button" class="btn-primary">
                    <i data-lucide="download" class="w-5 h-5 mr-2"></i> Download Ngrok (Windows)
                </button>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="flex flex-wrap justify-center bg-gray-700 rounded-t-lg p-2 mb-4">
            <button class="tab-button px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 hover:bg-blue-600 active" data-tab="tunnel-type">Tunnel Type</button>
            <button class="tab-button px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 hover:bg-blue-600" data-tab="http-options">HTTP Options</button>
            <button class="tab-button px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 hover:bg-blue-600" data-tab="tcp-options">TCP Options</button>
            <button class="tab-button px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 hover:bg-blue-600" data-tab="tunnel-options">Named Tunnel Options</button>
            <button class="tab-button px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 hover:bg-blue-600" data-tab="common-options">Common Options</button>
            <button class="tab-button px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 hover:bg-blue-600" data-tab="examples">Examples</button>
        </div>

        <!-- Tab Content -->
        <div id="tab-content-container" class="bg-gray-700 p-4 rounded-b-lg mb-4 max-h-[500px] overflow-y-auto custom-scrollbar">
            <!-- Tunnel Type Tab -->
            <div id="tunnel-type" class="tab-content active">
                <h2 class="text-xl font-semibold text-blue-300 mb-4">Select Tunnel Type</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex items-center">
                        <label for="command_type_select" class="w-48 text-right pr-4">Command Type:</label>
                        <select id="command_type_select" name="command_type_select" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" onchange="toggleTunnelTypeSections(); generateCommand()">
                            <option value="http" selected>HTTP Tunnel</option>
                            <option value="tcp">TCP Tunnel</option>
                            <option value="tunnel">Named Tunnel (from config)</option>
                            <option value="authtoken">Set Authtoken</option>
                        </select>
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('Select the type of Ngrok command you want to generate.')">?</button>
                    </div>
                </div>
                <div id="authtoken_section" class="mt-6 hidden">
                    <h3 class="text-lg font-semibold text-blue-300 mb-4">Authtoken Configuration</h3>
                    <div class="flex items-center">
                        <label for="authtoken_entry" class="w-48 text-right pr-4">Your Auth Token:</label>
                        <input type="text" id="authtoken_entry" name="authtoken_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" onkeyup="generateCommand()">
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('Enter your Ngrok authtoken. You can find it on your Ngrok dashboard after signing up.')">?</button>
                    </div>
                </div>
            </div>

            <!-- HTTP Options Tab -->
            <div id="http-options" class="tab-content">
                <h2 class="text-xl font-semibold text-blue-300 mb-4">HTTP Tunnel Options</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex items-center">
                        <label for="http_port_entry" class="w-48 text-right pr-4">Local Port/Address:</label>
                        <input type="text" id="http_port_entry" name="http_port_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., 8000 or localhost:8080" onkeyup="generateCommand()">
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('The local port or address (e.g., http://localhost:3000) to tunnel.')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="http_host_header_entry" class="w-48 text-right pr-4">Host Header (--host-header):</label>
                        <input type="text" id="http_host_header_entry" name="http_host_header_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., example.com" onkeyup="generateCommand()">
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('Rewrite the Host header of the upstream request. Use \'rewrite\' to rewrite to the ngrok URL.')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="http_hostname_entry" class="w-48 text-right pr-4">Hostname (--hostname):</label>
                        <input type="text" id="http_hostname_entry" name="http_hostname_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., myapp.ngrok.io" onkeyup="generateCommand()">
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('Reserve a static hostname for the tunnel (requires paid plan).')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="http_auth_entry" class="w-48 text-right pr-4">Auth (--auth):</label>
                        <input type="text" id="http_auth_entry" name="http_auth_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., user:password" onkeyup="generateCommand()">
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('Add HTTP basic authentication to the tunnel.')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="http_domain_entry" class="w-48 text-right pr-4">Domain (--domain):</label>
                        <input type="text" id="http_domain_entry" name="http_domain_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., example.com" onkeyup="generateCommand()">
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('Use a custom domain for the tunnel (requires paid plan and DNS setup).')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="http_subdomain_entry" class="w-48 text-right pr-4">Subdomain (--subdomain):</label>
                        <input type="text" id="http_subdomain_entry" name="http_subdomain_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., dev" onkeyup="generateCommand()">
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('Reserve a static subdomain for the tunnel (requires paid plan).')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="http_oauth_provider_select" class="w-48 text-right pr-4">OAuth Provider (--oauth):</label>
                        <select id="http_oauth_provider_select" name="http_oauth_provider_select" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" onchange="generateCommand()">
                            <option value="">None</option>
                            <option value="google">Google</option>
                            <option value="github">GitHub</option>
                            <option value="microsoft">Microsoft</option>
                            <option value="facebook">Facebook</option>
                            <option value="gitlab">GitLab</option>
                        </select>
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('Enable OAuth authentication for the tunnel (requires paid plan).')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="http_oauth_allow_emails_entry" class="w-48 text-right pr-4">OAuth Allowed Emails (--oauth-allow-emails):</label>
                        <input type="text" id="http_oauth_allow_emails_entry" name="http_oauth_allow_emails_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., user@example.com" onkeyup="generateCommand()">
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('Comma-separated list of email addresses to allow for OAuth.')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="http_oauth_allow_domains_entry" class="w-48 text-right pr-4">OAuth Allowed Domains (--oauth-allow-domains):</label>
                        <input type="text" id="http_oauth_allow_domains_entry" name="http_oauth_allow_domains_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., example.com" onkeyup="generateCommand()">
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('Comma-separated list of domains to allow for OAuth.')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="http_schemes_select" class="w-48 text-right pr-4">Schemes (--schemes):</label>
                        <select id="http_schemes_select" name="http_schemes_select" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" onchange="generateCommand()">
                            <option value="">http+https (Default)</option>
                            <option value="http">http</option>
                            <option value="https">https</option>
                        </select>
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('The schemes to listen for (http, https, or both).')">?</button>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="http_mutual_tls_var" name="http_mutual_tls_var" class="form-checkbox h-5 w-5 text-blue-600 rounded bg-gray-600 border-gray-500" onchange="generateCommand()">
                        <label for="http_mutual_tls_var" class="ml-2">Mutual TLS (--mutual-tls)</label>
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('Enable mutual TLS client certificate authentication (requires paid plan).')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="http_basic_auth_entry" class="w-48 text-right pr-4">Basic Auth (--basic-auth):</label>
                        <input type="text" id="http_basic_auth_entry" name="http_basic_auth_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., user:password" onkeyup="generateCommand()">
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('Add HTTP basic authentication to the tunnel.')">?</button>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="http_compression_var" name="http_compression_var" class="form-checkbox h-5 w-5 text-blue-600 rounded bg-gray-600 border-gray-500" onchange="generateCommand()">
                        <label for="http_compression_var" class="ml-2">Compression (--compression)</label>
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('Enable compression for HTTP tunnel traffic.')">?</button>
                    </div>
                </div>
            </div>

            <!-- TCP Options Tab -->
            <div id="tcp-options" class="tab-content">
                <h2 class="text-xl font-semibold text-blue-300 mb-4">TCP Tunnel Options</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex items-center">
                        <label for="tcp_port_entry" class="w-48 text-right pr-4">Local Port/Address:</label>
                        <input type="text" id="tcp_port_entry" name="tcp_port_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., 22 or localhost:3389" onkeyup="generateCommand()">
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('The local port or address to tunnel.')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="tcp_remote_addr_entry" class="w-48 text-right pr-4">Remote Address (--remote-addr):</label>
                        <input type="text" id="tcp_remote_addr_entry" name="tcp_remote_addr_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., tcp://0.tcp.ngrok.io:12345" onkeyup="generateCommand()">
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('Connect to a specific remote TCP address and port (requires paid plan).')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="tcp_host_header_entry_tcp" class="w-48 text-right pr-4">Host Header (--host-header):</label>
                        <input type="text" id="tcp_host_header_entry_tcp" name="tcp_host_header_entry_tcp" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., example.com" onkeyup="generateCommand()">
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('Rewrite the Host header of the upstream request for TCP tunnels.')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="tcp_auth_entry_tcp" class="w-48 text-right pr-4">Auth (--auth):</label>
                        <input type="text" id="tcp_auth_entry_tcp" name="tcp_auth_entry_tcp" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., user:password" onkeyup="generateCommand()">
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('Add HTTP basic authentication to the TCP tunnel (for HTTP traffic over TCP).')">?</button>
                    </div>
                </div>
            </div>

            <!-- Named Tunnel Options Tab -->
            <div id="tunnel-options" class="tab-content">
                <h2 class="text-xl font-semibold text-blue-300 mb-4">Named Tunnel Options</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex items-center">
                        <label for="tunnel_name_entry" class="w-48 text-right pr-4">Tunnel Name:</label>
                        <input type="text" id="tunnel_name_entry" name="tunnel_name_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., my_web_app" onkeyup="generateCommand()">
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('The name of a tunnel defined in your ngrok.yml configuration file.')">?</button>
                    </div>
                </div>
            </div>

            <!-- Common Options Tab -->
            <div id="common-options" class="tab-content">
                <h2 class="text-xl font-semibold text-blue-300 mb-4">Common Options (All Tunnel Types)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex items-center">
                        <label for="region_select" class="w-48 text-right pr-4">Region (--region):</label>
                        <select id="region_select" name="region_select" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" onchange="generateCommand()">
                            <option value="">us (United States)</option>
                            <option value="eu">eu (Europe)</option>
                            <option value="ap">ap (Asia/Pacific)</option>
                            <option value="au">au (Australia)</option>
                            <option value="sa">sa (South America)</option>
                            <option value="jp">jp (Japan)</option>
                            <option value="in">in (India)</option>
                        </select>
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('The Ngrok server region to connect to.')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="config_file_entry" class="w-48 text-right pr-4">Config File (--config):</label>
                        <input type="text" id="config_file_entry" name="config_file_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., /path/to/ngrok.yml" onkeyup="generateCommand()">
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('Path to a custom Ngrok configuration file.')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="log_file_entry" class="w-48 text-right pr-4">Log File (--log):</label>
                        <input type="text" id="log_file_entry" name="log_file_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., ngrok.log" onkeyup="generateCommand()">
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('Path to write Ngrok logs. Use \'stdout\' or \'stderr\' for console output.')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="log_level_select" class="w-48 text-right pr-4">Log Level (--log-level):</label>
                        <select id="log_level_select" name="log_level_select" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" onchange="generateCommand()">
                            <option value="">(Default)</option>
                            <option value="trace">trace</option>
                            <option value="debug">debug</option>
                            <option value="info">info</option>
                            <option value="warn">warn</option>
                            <option value="error">error</option>
                        </select>
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('The level of logging to display (trace, debug, info, warn, error).')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="metadata_entry" class="w-48 text-right pr-4">Metadata (--metadata):</label>
                        <input type="text" id="metadata_entry" name="metadata_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., env=dev,user=admin" onkeyup="generateCommand()">
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('Arbitrary key-value metadata to attach to the tunnel.')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="proxy_url_entry" class="w-48 text-right pr-4">Proxy URL (--proxy-url):</label>
                        <input type="text" id="proxy_url_entry" name="proxy_url_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., http://myproxy:8080" onkeyup="generateCommand()">
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('URL of a proxy server to use for Ngrok connections.')">?</button>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="inspect_var" name="inspect_var" class="form-checkbox h-5 w-5 text-blue-600 rounded bg-gray-600 border-gray-500" onchange="generateCommand()">
                        <label for="inspect_var" class="ml-2">Inspect (--inspect)</label>
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('Enable inspection of tunnel traffic via the web interface.')">?</button>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="debug_var" name="debug_var" class="form-checkbox h-5 w-5 text-blue-600 rounded bg-gray-600 border-gray-500" onchange="generateCommand()">
                        <label for="debug_var" class="ml-2">Debug (--debug)</label>
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('Enable debug logging (more verbose output).')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="log_format_select" class="w-48 text-right pr-4">Log Format (--log-format):</label>
                        <select id="log_format_select" name="log_format_select" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" onchange="generateCommand()">
                            <option value="">(Default)</option>
                            <option value="term">term</option>
                            <option value="json">json</option>
                        </select>
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('The format of Ngrok logs (term or json).')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="hostname_entry_common" class="w-48 text-right pr-4">Hostname (--hostname):</label>
                        <input type="text" id="hostname_entry_common" name="hostname_entry_common" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., myapp.ngrok.io" onkeyup="generateCommand()">
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('Reserve a static hostname for the tunnel (requires paid plan).')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="domain_entry_common" class="w-48 text-right pr-4">Domain (--domain):</label>
                        <input type="text" id="domain_entry_common" name="domain_entry_common" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., example.com" onkeyup="generateCommand()">
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('Use a custom domain for the tunnel (requires paid plan and DNS setup).')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="subdomain_entry_common" class="w-48 text-right pr-4">Subdomain (--subdomain):</label>
                        <input type="text" id="subdomain_entry_common" name="subdomain_entry_common" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., dev" onkeyup="generateCommand()">
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('Reserve a static subdomain for the tunnel (requires paid plan).')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="auth_entry_common" class="w-48 text-right pr-4">Auth (--auth):</label>
                        <input type="text" id="auth_entry_common" name="auth_entry_common" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., user:password" onkeyup="generateCommand()">
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('Add HTTP basic authentication to the tunnel.')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="scheme_select_common" class="w-48 text-right pr-4">Schemes (--schemes):</label>
                        <select id="scheme_select_common" name="scheme_select_common" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" onchange="generateCommand()">
                            <option value="">http+https (Default)</option>
                            <option value="http">http</option>
                            <option value="https">https</option>
                        </select>
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('The schemes to listen for (http, https, or both).')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="oauth_provider_select_common" class="w-48 text-right pr-4">OAuth Provider (--oauth):</label>
                        <select id="oauth_provider_select_common" name="oauth_provider_select_common" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" onchange="generateCommand()">
                            <option value="">None</option>
                            <option value="google">Google</option>
                            <option value="github">GitHub</option>
                            <option value="microsoft">Microsoft</option>
                            <option value="facebook">Facebook</option>
                            <option value="gitlab">GitLab</option>
                        </select>
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('Enable OAuth authentication for the tunnel (requires paid plan).')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="oauth_allow_emails_entry_common" class="w-48 text-right pr-4">OAuth Allowed Emails (--oauth-allow-emails):</label>
                        <input type="text" id="oauth_allow_emails_entry_common" name="oauth_allow_emails_entry_common" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., user@example.com" onkeyup="generateCommand()">
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('Comma-separated list of email addresses to allow for OAuth.')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="oauth_allow_domains_entry_common" class="w-48 text-right pr-4">OAuth Allowed Domains (--oauth-allow-domains):</label>
                        <input type="text" id="oauth_allow_domains_entry_common" name="oauth_allow_domains_entry_common" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., example.com" onkeyup="generateCommand()">
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('Comma-separated list of domains to allow for OAuth.')">?</button>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="mutual_tls_var_common" name="mutual_tls_var_common" class="form-checkbox h-5 w-5 text-blue-600 rounded bg-gray-600 border-gray-500" onchange="generateCommand()">
                        <label for="mutual_tls_var_common" class="ml-2">Mutual TLS (--mutual-tls)</label>
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('Enable mutual TLS client certificate authentication (requires paid plan).')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="basic_auth_entry_common" class="w-48 text-right pr-4">Basic Auth (--basic-auth):</label>
                        <input type="text" id="basic_auth_entry_common" name="basic_auth_entry_common" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., user:password" onkeyup="generateCommand()">
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('Add HTTP basic authentication to the tunnel.')">?</button>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="compression_var_common" name="compression_var_common" class="form-checkbox h-5 w-5 text-blue-600 rounded bg-gray-600 border-gray-500" onchange="generateCommand()">
                        <label for="compression_var_common" class="ml-2">Compression (--compression)</label>
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('Enable compression for HTTP tunnel traffic.')">?</button>
                    </div>
                    <div class="flex items-start">
                        <label for="additional_args_entry" class="w-48 text-right pr-4 pt-2">Additional Arguments:</label>
                        <textarea id="additional_args_entry" name="additional_args_entry" rows="4" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" onkeyup="generateCommand()"></textarea>
                        <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" onclick="showHelp('Any other Ngrok arguments not covered by the GUI. Enter them exactly as you would on the command line (e.g., \'--log-format json\').')">?</button>
                    </div>
                </div>
            </div>

            <!-- Examples Tab -->
            <div id="examples" class="tab-content">
                <h2 class="text-xl font-semibold text-blue-300 mb-4">Examples</h2>
                <div class="mb-4 flex items-center">
                    <label for="example_search_entry" class="w-32 text-right pr-4">Search Examples:</label>
                    <input type="text" id="example_search_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" onkeyup="filterExamples()">
                    <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded" onclick="clearExampleSearch()">Clear Search</button>
                </div>
                <div id="examples_list" class="grid grid-cols-1 gap-4">
                    <!-- Examples will be loaded here by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Generated Command -->
        <div class="bg-gray-700 p-4 rounded-lg shadow-md mb-4">
            <h2 class="text-xl font-semibold text-blue-300 mb-2">Generated Ngrok Command</h2>
            <textarea id="command_text" class="w-full h-24 p-2 rounded bg-gray-900 text-blue-400 font-mono text-sm resize-none custom-scrollbar" readonly></textarea>
            <div class="flex justify-end mt-2 space-x-2">
                <button class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md transition-colors duration-200" onclick="copyCommand()">Copy Command</button>
                <button class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md transition-colors duration-200" onclick="generateCommand()">Generate Command</button>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-center space-x-4 mb-4">
            <button id="run_ngrok_button" class="btn-success">
                <i data-lucide="play" class="w-6 h-6 mr-2"></i> Run Ngrok
            </button>
            <button id="stop_ngrok_button" class="btn-danger" disabled>
                <i data-lucide="square" class="w-6 h-6 mr-2"></i> Stop Ngrok
            </button>
            <button class="btn-info" onclick="clearOutput()">
                <i data-lucide="trash-2" class="w-6 h-6 mr-2"></i> Clear Output
            </button>
            <button class="btn-info" onclick="saveOutput()">
                <i data-lucide="save" class="w-6 h-6 mr-2"></i> Save Output
            </button>
        </div>

        <!-- Status Bar -->
        <div id="status_bar" class="bg-gray-900 text-white text-sm p-2 rounded-md mb-4 text-center">Ready</div>

        <!-- Ngrok Output -->
        <div class="bg-gray-700 p-4 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold text-blue-300 mb-2">Ngrok Output</h2>
            <div class="flex items-center mb-2">
                <label for="search_entry" class="pr-2">Search:</label>
                <input type="text" id="search_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" onkeyup="searchOutput()">
                <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded" onclick="searchOutput()">Search</button>
                <button class="ml-2 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded" onclick="clearSearchHighlight()">Clear Search</button>
            </div>
            <pre id="output_text" class="w-full h-96 p-2 rounded bg-gray-900 text-gray-200 font-mono text-sm overflow-auto custom-scrollbar"></pre>
        </div>
    </div>

    <!-- Footer -->
    <div class="text-gray-500 text-sm mt-4">
        Created by khedr0x00
    </div>

    <!-- Global Message/Alert Modal -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="messageModalTitle">Alert</h2>
                <span class="modal-close" onclick="closeMessageModal()">&times;</span>
            </div>
            <div class="modal-body" id="messageModalBody"></div>
            <div class="modal-footer">
                <button onclick="closeMessageModal()" class="btn-primary">OK</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal for Linux/Termux Installation -->
    <div id="installConfirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="installConfirmModalTitle">Confirm Installation</h2>
                <span class="modal-close" onclick="closeInstallConfirmModal()">&times;</span>
            </div>
            <div class="modal-body" id="installConfirmModalBody"></div>
            <div class="modal-footer flex justify-end space-x-4">
                <button onclick="closeInstallConfirmModal()" class="btn-secondary">Cancel</button>
                <button id="confirmInstallButton" class="btn-success">Install Now</button>
            </div>
        </div>
    </div>

    <!-- Example Output Modal -->
    <div id="exampleOutputModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="exampleOutputModalTitle">Example Output</h2>
                <span class="modal-close" onclick="closeExampleOutputModal()">&times;</span>
            </div>
            <div class="modal-body">
                <pre id="exampleOutputModalText" class="w-full h-auto p-2 rounded bg-gray-900 text-gray-200 font-mono text-sm overflow-auto custom-scrollbar"></pre>
            </div>
            <div class="modal-footer">
                <button onclick="closeExampleOutputModal()" class="btn-primary">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Global variable to store examples
        let allExamples = [];
        let currentTunnelId = null;
        let pollInterval = null;
        let searchStartIndex = 0; // For incremental search in output
        let currentOutputBuffer = ""; // Buffer to accumulate real-time output

        // Function to show/hide tabs
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
            generateCommand(); // Regenerate command on tab change
        }

        // Event listeners for tab buttons
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                showTab(button.dataset.tab);
            });
        });

        // Toggle sections based on selected command type
        function toggleTunnelTypeSections() {
            const commandType = document.getElementById('command_type_select').value;
            document.getElementById('http-options').style.display = 'none';
            document.getElementById('tcp-options').style.display = 'none';
            document.getElementById('tunnel-options').style.display = 'none';
            document.getElementById('authtoken_section').classList.add('hidden');

            // Hide common options for authtoken, show for others
            const commonOptionsTab = document.querySelector('.tab-button[data-tab="common-options"]');
            if (commandType === 'authtoken') {
                commonOptionsTab.style.display = 'none';
                document.getElementById('authtoken_section').classList.remove('hidden');
                // Ensure only tunnel-type tab is active
                showTab('tunnel-type');
            } else {
                commonOptionsTab.style.display = 'block';
                // Show the relevant tab based on command type
                if (commandType === 'http') {
                    showTab('http-options');
                } else if (commandType === 'tcp') {
                    showTab('tcp-options');
                } else if (commandType === 'tunnel') {
                    showTab('tunnel-options');
                }
            }
        }

        // --- Helper for showing custom modals ---
        function showMessageModal(title, message, isHtml = false) {
            document.getElementById('messageModalTitle').innerText = title;
            const messageBody = document.getElementById('messageModalBody');
            if (isHtml) {
                messageBody.innerHTML = message;
            } else {
                messageBody.innerText = message;
            }
            document.getElementById('messageModal').style.display = 'flex';
        }

        function closeMessageModal() {
            document.getElementById('messageModal').style.display = 'none';
        }

        function showInstallConfirmModal(title, message, onConfirm) {
            document.getElementById('installConfirmModalTitle').innerText = title;
            document.getElementById('installConfirmModalBody').innerHTML = message;
            const confirmButton = document.getElementById('confirmInstallButton');
            confirmButton.onclick = () => {
                closeInstallConfirmModal();
                onConfirm();
            };
            document.getElementById('installConfirmModal').style.display = 'flex';
        }

        function closeInstallConfirmModal() {
            document.getElementById('installConfirmModal').style.display = 'none';
        }

        function showExampleOutputModal(title, output) {
            document.getElementById('exampleOutputModalTitle').innerText = title;
            const outputPre = document.getElementById('exampleOutputModalText');
            outputPre.innerHTML = ''; // Clear previous content

            // Apply coloring based on Ngrok-like output
            insertColoredText(outputPre, output);
            document.getElementById('exampleOutputModal').style.display = 'flex';
        }

        function closeExampleOutputModal() {
            document.getElementById('exampleOutputModal').style.display = 'none';
        }


        // Function to collect form data
        function getFormData() {
            const formData = {};
            document.querySelectorAll('#tab-content-container input, #tab-content-container select, #tab-content-container textarea').forEach(element => {
                if (element.type === 'checkbox') {
                    formData[element.id] = element.checked;
                } else if (element.type === 'number') {
                    formData[element.id] = element.value ? parseFloat(element.value) : '';
                }
                else {
                    formData[element.id] = element.value;
                }
            });
            return formData;
        }

        // Function to generate Ngrok command
        async function generateCommand() {
            const formData = getFormData();
            try {
                const response = await fetch('/generate_command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData),
                });
                const data = await response.json();
                document.getElementById('command_text').value = data.command;
            } catch (error) {
                console.error('Error generating command:', error);
                document.getElementById('command_text').value = 'Error generating command.';
            }
        }

        // Function to copy command to clipboard
        function copyCommand() {
            const commandText = document.getElementById('command_text');
            commandText.select();
            document.execCommand('copy');
            showMessageModal('Command Copied', 'The command has been copied to your clipboard!');
        }

        // Function to run Ngrok
        async function runNgrok() {
            if (currentTunnelId) {
                showMessageModal('Ngrok Running', 'Ngrok is already running. Please stop the current tunnel before starting a new one.');
                return;
            }

            const command = document.getElementById('command_text').value;
            if (!command) {
                showMessageModal('Error', 'No command to run.');
                return;
            }

            // Disable run button, enable stop button, and clear output
            document.getElementById('run_ngrok_button').disabled = true;
            document.getElementById('stop_ngrok_button').disabled = false;
            document.getElementById('output_text').innerHTML = '';
            currentOutputBuffer = "";
            clearSearchHighlight();
            showStatus('Starting Ngrok tunnel...', 'blue');

            try {
                const response = await fetch('/run_ngrok', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ command: command }),
                });
                const data = await response.json();
                if (data.status === 'error') {
                    showMessageModal('Error', data.message);
                    showStatus(`Error: ${data.message}`, 'red');
                    document.getElementById('run_ngrok_button').disabled = false;
                    document.getElementById('stop_ngrok_button').disabled = true;
                } else {
                    currentTunnelId = data.tunnel_id;
                    showStatus(`Ngrok tunnel started (ID: ${currentTunnelId}). Fetching output...`, 'blue');
                    // Start polling for output
                    pollInterval = setInterval(pollOutput, 500); // Poll every 500ms
                }
            } catch (error) {
                console.error('Error starting Ngrok:', error);
                showMessageModal('Error', 'An error occurred while starting Ngrok.');
                showStatus('An error occurred while starting Ngrok.', 'red');
                document.getElementById('run_ngrok_button').disabled = false;
                document.getElementById('stop_ngrok_button').disabled = true;
            }
        }

        // Function to stop Ngrok
        async function stopNgrok() {
            if (!currentTunnelId) {
                showMessageModal('Ngrok Not Running', 'No Ngrok tunnel is currently running.');
                return;
            }

            showStatus('Stopping Ngrok tunnel...', 'orange');
            document.getElementById('stop_ngrok_button').disabled = true; // Disable stop button during stop attempt

            try {
                const response = await fetch(`/stop_ngrok/${currentTunnelId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                const data = await response.json();

                if (data.status === 'success') {
                    showMessageModal('Tunnel Stopped', data.message);
                    showStatus('Ngrok tunnel stopped successfully.', 'green');
                    // Clear interval and reset state immediately
                    clearInterval(pollInterval);
                    pollInterval = null;
                    currentTunnelId = null;
                    document.getElementById('run_ngrok_button').disabled = false;
                    document.getElementById('stop_ngrok_button').disabled = true;
                } else {
                    showMessageModal('Error Stopping Tunnel', data.message);
                    showStatus(`Error stopping tunnel: ${data.message}`, 'red');
                    document.getElementById('stop_ngrok_button').disabled = false; // Re-enable if stop failed
                }
            } catch (error) {
                console.error('Error stopping Ngrok:', error);
                showMessageModal('Error Stopping Tunnel', 'An error occurred while trying to stop the Ngrok tunnel.');
                showStatus('An error occurred while stopping Ngrok.', 'red');
                document.getElementById('stop_ngrok_button').disabled = false; // Re-enable on network error
            }
        }


        // Polling for Ngrok output
        async function pollOutput() {
            if (!currentTunnelId) {
                clearInterval(pollInterval);
                pollInterval = null;
                return;
            }

            try {
                const response = await fetch(`/get_tunnel_output/${currentTunnelId}`);
                const data = await response.json();
                const outputTextElement = document.getElementById('output_text');
                
                if (data.output) {
                    // Only append new output to the buffer
                    const newOutputSegment = data.output.substring(currentOutputBuffer.length);
                    currentOutputBuffer += newOutputSegment;
                    insertColoredText(outputTextElement, currentOutputBuffer);
                }

                if (data.status === 'running') {
                    showStatus('Ngrok is running...', 'blue');
                } else if (data.status === 'completed' || data.status === 'success' || data.status === 'error' || data.status === 'info') {
                    clearInterval(pollInterval);
                    pollInterval = null;
                    currentTunnelId = null;
                    currentOutputBuffer = data.output; // Get final complete output
                    insertColoredText(outputTextElement, currentOutputBuffer);
                    if (data.status === 'completed' || data.status === 'success') {
                        showStatus('Ngrok process completed successfully.', 'green');
                    } else if (data.status === 'info') {
                        showStatus(`Info: ${data.message}`, 'orange');
                        showMessageModal('Ngrok Info', data.message, true); // Use isHtml=true for instructions
                    }
                    else {
                        showStatus(`Process failed: ${data.message || 'Unknown error'}`, 'red');
                        showMessageModal('Process Error', data.message || 'An unknown error occurred during the Ngrok process.');
                    }
                    document.getElementById('run_ngrok_button').disabled = false;
                    document.getElementById('stop_ngrok_button').disabled = true;
                    // Re-enable install buttons if they were disabled for installation
                    document.getElementById('install_ngrok_linux_button').disabled = false;
                    document.getElementById('install_ngrok_termux_button').disabled = false;
                    document.getElementById('download_ngrok_windows_button').disabled = false;
                } else if (data.status === 'not_found') {
                    clearInterval(pollInterval);
                    pollInterval = null;
                    currentTunnelId = null;
                    showStatus(`Process failed: ${data.message || 'Tunnel ID not found or expired.'}`, 'red');
                    showMessageModal('Process Error', data.message || 'Tunnel ID not found or expired.');
                    document.getElementById('run_ngrok_button').disabled = false;
                    document.getElementById('stop_ngrok_button').disabled = true;
                    // Re-enable install buttons if they were disabled for installation
                    document.getElementById('install_ngrok_linux_button').disabled = false;
                    document.getElementById('install_ngrok_termux_button').disabled = false;
                    document.getElementById('download_ngrok_windows_button').disabled = false;
                }
            } catch (error) {
                console.error('Error polling output:', error);
                showMessageModal('Polling Error', 'An error occurred while fetching output.');
                showStatus('An error occurred while fetching output.', 'red');
                clearInterval(pollInterval);
                pollInterval = null;
                currentTunnelId = null;
                document.getElementById('run_ngrok_button').disabled = false;
                document.getElementById('stop_ngrok_button').disabled = true;
                // Re-enable install buttons if they were disabled for installation
                document.getElementById('install_ngrok_linux_button').disabled = false;
                document.getElementById('install_ngrok_termux_button').disabled = false;
                document.getElementById('download_ngrok_windows_button').disabled = false;
            }
        }

        // Helper to insert colored text based on Ngrok output patterns
        function insertColoredText(element, text) {
            element.innerHTML = ''; // Clear current content to re-insert with spans
            const lines = text.split('\n');
            const fragment = document.createDocumentFragment();

            lines.forEach(line => {
                const span = document.createElement('span');
                let className = 'output-default';

                if (line.toLowerCase().includes('forwarding') || line.toLowerCase().includes('session status') || line.toLowerCase().includes('online')) {
                    className = 'output-green';
                } else if (line.toLowerCase().includes('error') || line.toLowerCase().includes('failed')) {
                    className = 'output-red';
                } else if (line.toLowerCase().includes('starting') || line.toLowerCase().includes('version') || line.toLowerCase().includes('region') || line.toLowerCase().includes('web interface') || line.toLowerCase().includes('connections') || line.toLowerCase().includes('authtoken saved') || line.toLowerCase().includes('detected')) {
                    className = 'output-blue';
                } else if (line.toLowerCase().includes('warning') || line.toLowerCase().includes('info')) {
                    className = 'output-orange';
                }
                
                span.className = className;
                span.textContent = line + '\n'; // Add newline back for pre tag
                fragment.appendChild(span);
            });
            element.appendChild(fragment);
            element.scrollTop = element.scrollHeight; // Scroll to bottom
        }

        // Function to clear output
        function clearOutput() {
            document.getElementById('output_text').innerHTML = '';
            currentOutputBuffer = "";
            showStatus('Ready');
            clearSearchHighlight();
            if (currentTunnelId) {
                clearInterval(pollInterval);
                pollInterval = null;
                currentTunnelId = null;
            }
            document.getElementById('run_ngrok_button').disabled = false;
            document.getElementById('stop_ngrok_button').disabled = true;
        }

        // Function to save output
        async function saveOutput() {
            const outputContent = document.getElementById('output_text').innerText;
            if (!outputContent.trim()) {
                showMessageModal('Save Output', 'No output to save.');
                return;
            }

            // Prompt for filename (simple browser prompt)
            const defaultFilename = `ngrok_output_${new Date().toISOString().slice(0,10)}.txt`;
            const filename = prompt("Enter filename to save:", defaultFilename);

            if (filename) {
                try {
                    const response = await fetch('/save_output', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content: outputContent, filename: filename })
                    });
                    const data = await response.json();

                    if (data.status === 'success') {
                        showMessageModal('Save Output', `Output saved on the server. You can download it now.`);
                        // Offer download link
                        if (data.download_url) {
                            const downloadLink = document.createElement('a');
                            downloadLink.href = data.download_url;
                            downloadLink.download = filename; // Suggest filename for download
                            downloadLink.style.display = 'none';
                            document.body.appendChild(downloadLink);
                            downloadLink.click();
                            document.body.removeChild(downloadLink);
                        }
                    } else {
                        showMessageModal('Save Error', `Failed to save file: ${data.message}`);
                    }
                } catch (error) {
                    console.error('Error saving output:', error);
                    showMessageModal('Save Error', `Failed to save file: ${error.message}`);
                }
            }
        }

        // Function to update status bar
        function showStatus(message, color = 'white') {
            const statusBar = document.getElementById('status_bar');
            statusBar.textContent = message;
            statusBar.style.color = color;
        }

        // Function to search output
        function searchOutput() {
            const searchTerm = document.getElementById('search_entry').value.trim().toLowerCase();
            const outputTextElement = document.getElementById('output_text');
            const fullText = outputTextElement.textContent; // Use textContent to get plain text

            clearSearchHighlight(); // Clear existing highlights first

            if (!searchTerm) {
                searchStartIndex = 0;
                return;
            }

            let found = false;
            let newContent = '';
            let lastIndex = 0;

            const regex = new RegExp(searchTerm, 'gi'); // 'gi' for global and case-insensitive

            let match;
            while ((match = regex.exec(fullText)) !== null) {
                found = true;
                const index = match.index;
                const matchedText = match[0];

                // Append content before the match
                newContent += escapeHtml(fullText.substring(lastIndex, index));
                // Append the highlighted match
                newContent += `<mark class="highlight">${escapeHtml(matchedText)}</mark>`;
                lastIndex = index + matchedText.length;
            }
            newContent += escapeHtml(fullText.substring(lastIndex)); // Append remaining content

            outputTextElement.innerHTML = newContent;

            if (!found) {
                showMessageModal('Search', `No occurrences of '${searchTerm}' found.`);
            } else {
                // Scroll to the first highlighted element
                const firstHighlight = outputTextElement.querySelector('mark.highlight');
                if (firstHighlight) {
                    firstHighlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        // Function to clear search highlight
        function clearSearchHighlight() {
            const outputTextElement = document.getElementById('output_text');
            const currentContent = outputTextElement.textContent; // Get plain text content
            outputTextElement.innerHTML = ''; // Clear existing content
            insertColoredText(outputTextElement, currentContent); // Re-insert without highlights
            searchStartIndex = 0;
        }

        // Function to show help popup
        function showHelp(helpText) {
            const overlay = document.createElement('div');
            overlay.className = 'help-popup-overlay';
            overlay.onclick = () => {
                document.body.removeChild(overlay);
                document.body.removeChild(popup);
            };
            document.body.appendChild(overlay);

            const popup = document.createElement('div');
            popup.className = 'help-popup';
            popup.innerHTML = `
                <h3 class="text-xl font-bold text-blue-300 mb-4">Help</h3>
                <div class="flex-grow overflow-y-auto custom-scrollbar p-2 bg-gray-600 rounded text-gray-200 text-sm mb-4">
                    ${helpText.replace(/\n/g, '<br>')}
                </div>
                <button class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md self-center" onclick="this.parentNode.parentNode.removeChild(this.parentNode); document.body.removeChild(document.querySelector('.help-popup-overlay'));">Close</button>
            `;
            document.body.appendChild(popup);
        }

        // --- Examples Tab Functions ---
        async function loadExamples() {
            try {
                // Fetch examples from the backend (assuming /get_examples endpoint)
                const response = await fetch('/get_examples');
                if (response.ok) {
                    allExamples = await response.json();
                } else {
                    console.warn("Could not fetch examples from backend, using hardcoded examples.");
                    // Fallback to hardcoded examples if backend fails
                    allExamples = [
                        {
                            "name": "Basic HTTP Tunnel",
                            "description": "Exposes a local web server (e.g., running on port 8000) to the internet via HTTP.",
                            "options": {
                                "command_type_select": "http",
                                "http_port_entry": "8000"
                            },
                            "example_output": "ngrok http 8000\n\nSession Status                online\nVersion                       3.x.x\nRegion                        us\nLatency                       50ms\nWeb Interface                 http://127.0.0.1:4040\nForwarding                    http://<random_id>.ngrok-free.app -> http://localhost:8000\nForwarding                    https://<random_id>.ngrok-free.app -> http://localhost:8000\n\nConnections                   ttl     opn     rt1     rt5     p50     p90\n                              0       0       0.00    0.00    0.00    0.00"
                        },
                        {
                            "name": "Basic TCP Tunnel",
                            "description": "Exposes a local TCP service (e.g., SSH on port 22) to the internet.",
                            "options": {
                                "command_type_select": "tcp",
                                "tcp_port_entry": "22"
                            },
                            "example_output": "ngrok tcp 22\n\nSession Status                online\nVersion                       3.x.x\nRegion                        us\nLatency                       50ms\nWeb Interface                 http://127.0.0.1:4040\nForwarding                    tcp://<random_id>.tcp.ngrok.io:12345 -> localhost:22\n\nConnections                   ttl     opn     rt1     rt5     p50     p90\n                              0       0       0.00    0.00    0.00    0.00"
                        },
                        {
                            "name": "Set Authtoken",
                            "description": "Sets your Ngrok authtoken for persistent authentication. Replace YOUR_AUTH_TOKEN.",
                            "options": {
                                "command_type_select": "authtoken",
                                "authtoken_entry": "YOUR_AUTH_TOKEN_HERE"
                            },
                            "example_output": "ngrok authtoken YOUR_AUTH_TOKEN_HERE\n\nAuthtoken saved to configuration file: /home/user/.config/ngrok/ngrok.yml"
                        }
                    ];
                }
                filterExamples(); // Display all examples initially
            } catch (error) {
                console.error('Error loading examples:', error);
                showStatus('Error loading examples. Using hardcoded examples.', 'red');
                // Ensure allExamples is populated even if fetch fails
                allExamples = [
                    {
                        "name": "Basic HTTP Tunnel",
                        "description": "Exposes a local web server (e.g., running on port 8000) to the internet via HTTP.",
                        "options": {
                            "command_type_select": "http",
                            "http_port_entry": "8000"
                        },
                        "example_output": "ngrok http 8000\n\nSession Status                online\nVersion                       3.x.x\nRegion                        us\nLatency                       50ms\nWeb Interface                 http://127.0.0.1:4040\nForwarding                    http://<random_id>.ngrok-free.app -> http://localhost:8000\nForwarding                    https://<random_id>.ngrok-free.app -> http://localhost:8000\n\nConnections                   ttl     opn     rt1     rt5     p50     p90\n                              0       0       0.00    0.00    0.00    0.00"
                    },
                    {
                        "name": "Basic TCP Tunnel",
                        "description": "Exposes a local TCP service (e.g., SSH on port 22) to the internet.",
                        "options": {
                            "command_type_select": "tcp",
                            "tcp_port_entry": "22"
                        },
                        "example_output": "ngrok tcp 22\n\nSession Status                online\nVersion                       3.x.x\nRegion                        us\nLatency                       50ms\nWeb Interface                 http://127.0.0.1:4040\nForwarding                    tcp://<random_id>.tcp.ngrok.io:12345 -> localhost:22\n\nConnections                   ttl     opn     rt1     rt5     p50     p90\n                              0       0       0.00    0.00    0.00    0.00"
                    },
                    {
                        "name": "Set Authtoken",
                        "description": "Sets your Ngrok authtoken for persistent authentication. Replace YOUR_AUTH_TOKEN.",
                        "options": {
                            "command_type_select": "authtoken",
                            "authtoken_entry": "YOUR_AUTH_TOKEN_HERE"
                        },
                        "example_output": "ngrok authtoken YOUR_AUTH_TOKEN_HERE\n\nAuthtoken saved to configuration file: /home/user/.config/ngrok/ngrok.yml"
                    }
                ];
                filterExamples();
            }
        }


        function filterExamples() {
            const searchQuery = document.getElementById('example_search_entry').value.toLowerCase();
            const examplesList = document.getElementById('examples_list');
            examplesList.innerHTML = ''; // Clear current list

            allExamples.forEach(example => {
                if (example.name.toLowerCase().includes(searchQuery) || example.description.toLowerCase().includes(searchQuery)) {
                    const exampleDiv = document.createElement('div');
                    exampleDiv.className = 'bg-gray-800 p-4 rounded-lg shadow-md flex flex-col md:flex-row justify-between items-start md:items-center';
                    exampleDiv.innerHTML = `
                        <div>
                            <h3 class="text-lg font-semibold text-blue-300">${escapeHtml(example.name)}</h3>
                            <p class="text-sm text-gray-400 mb-2 md:mb-0">${escapeHtml(example.description)}</p>
                        </div>
                        <div class="flex mt-2 md:mt-0 space-x-2">
                            <button class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-md text-sm" onclick="loadExampleOptions(${escapeHtml(JSON.stringify(example.options))})">Select</button>
                            <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded-md text-sm" onclick="showExampleOutputModal('${escapeHtml(example.name)} Output', ${escapeHtml(JSON.stringify(example.example_output))})">Output</button>
                        </div>
                    `;
                    examplesList.appendChild(exampleDiv);
                }
            });
            lucide.createIcons(); // Re-render Lucide icons for new elements
        }

        function clearExampleSearch() {
            document.getElementById('example_search_entry').value = '';
            filterExamples();
        }

        function loadExampleOptions(options) {
            clearAllInputs(); // Clear all inputs first

            // Populate form fields with example options
            for (const key in options) {
                const element = document.getElementById(key);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = options[key];
                    } else if (element.tagName === 'TEXTAREA') {
                        element.value = options[key];
                    } else {
                        element.value = options[key];
                    }
                }
            }
            toggleTunnelTypeSections(); // Adjust visibility based on loaded command type
            generateCommand(); // Re-generate command after loading
            showMessageModal('Example Loaded', 'Example options have been loaded. Check other tabs and the generated command.');
        }

        // Helper to escape HTML for safe display
        function escapeHtml(text) {
            if (typeof text !== 'string') {
                text = String(text);
            }
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // Helper to unescape HTML entities
        function unescapeHtml(html) {
            const doc = new DOMParser().parseFromString(html, 'text/html');
            return doc.documentElement.textContent;
        }

        function clearAllInputs() {
            document.querySelectorAll('#tab-content-container input[type="text"], #tab-content-container input[type="number"], #tab-content-container textarea').forEach(element => {
                element.value = '';
            });
            document.querySelectorAll('#tab-content-container input[type="checkbox"]').forEach(element => {
                element.checked = false;
            });
            document.querySelectorAll('#tab-content-container select').forEach(element => {
                element.value = ''; // Clear dropdown selection
            });
            // Reset specific default values
            document.getElementById('command_type_select').value = 'http';
            document.getElementById('http_schemes_select').value = ''; // Default to http+https
            document.getElementById('region_select').value = ''; // Default to us
            document.getElementById('log_level_select').value = ''; // Default
            document.getElementById('log_format_select').value = ''; // Default
            generateCommand();
        }

        // Function to handle Ngrok installation
        async function handleNgrokInstallation(platformType) {
            const linuxButton = document.getElementById('install_ngrok_linux_button');
            const termuxButton = document.getElementById('install_ngrok_termux_button');
            const windowsButton = document.getElementById('download_ngrok_windows_button');

            // Disable all install buttons during an installation attempt
            linuxButton.disabled = true;
            termuxButton.disabled = true;
            windowsButton.disabled = true;

            showStatus('Checking system and preparing for installation...', 'blue');
            document.getElementById('output_text').innerHTML = ''; // Clear output area
            currentOutputBuffer = ""; // Clear output buffer for installation logs

            if (platformType === 'linux' || platformType === 'termux') {
                const osName = platformType === 'termux' ? "Termux" : "Linux";
                showInstallConfirmModal(
                    'Install Ngrok',
                    `Your operating system is <strong>${osName}</strong>. Do you want to attempt to install Ngrok now? This might require superuser privileges on Linux and could ask for your password in the server console. For Linux, manual steps might still be required.`,
                    async () => {
                        // This function will be called if the user confirms
                        showStatus(`Attempting Ngrok installation on ${osName}...`, 'blue');
                        try {
                            const response = await fetch('/install_ngrok', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ platform: platformType }) // Pass platform type to backend
                            });
                            const data = await response.json();

                            if (data.status === 'error') {
                                showStatus(`Ngrok installation failed: ${data.message}`, 'red');
                                showMessageModal('Ngrok Installation Failed', `Failed to install/update Ngrok: ${data.message}<br><br>Output:<pre>${escapeHtml(data.output)}</pre>`, true);
                                insertColoredText(document.getElementById('output_text'), data.output);
                                // Re-enable buttons on error
                                linuxButton.disabled = false;
                                termuxButton.disabled = false;
                                windowsButton.disabled = false;
                            } else { // status is 'running' for real-time output or 'info' for Windows/Linux instructions
                                currentTunnelId = data.install_id; // Use the install_id returned by the backend
                                showStatus(`Ngrok installation started (ID: ${currentTunnelId}). Fetching output...`, 'blue');
                                pollInterval = setInterval(pollOutput, 500); // Start polling for output
                            }
                        } catch (error) {
                            console.error('Error during Ngrok installation fetch:', error);
                            showStatus('An error occurred during installation.', 'red');
                            showMessageModal('Ngrok Installation Error', `An error occurred while trying to install Ngrok: ${error.message}. Check server logs for more details.`);
                            // Re-enable buttons on error
                            linuxButton.disabled = false;
                            termuxButton.disabled = false;
                            windowsButton.disabled = false;
                        }
                    }
                );
            } else if (platformType === 'windows') {
                const downloadMessage = `Ngrok cannot be installed directly via this web interface on Windows.
                <br><br>
                Please download it from the official Ngrok website:
                <br><br>
                <a href="https://ngrok.com/download" target="_blank" class="text-blue-400 hover:underline">Download Ngrok for Windows</a>
                <br><br>
                After downloading, unzip the file and place the 'ngrok.exe' executable in a directory included in your system's PATH, or run it from its extracted location. Then, set your authtoken: <code>ngrok authtoken YOUR_AUTH_TOKEN</code>.`;
                showMessageModal('Install Ngrok', downloadMessage, true); // Use isHtml = true
                showStatus('Ngrok installation is not directly supported on Windows via this interface.', 'orange');
                // Re-enable buttons immediately for Windows as no backend process is started
                linuxButton.disabled = false;
                termuxButton.disabled = false;
                windowsButton.disabled = false;
            } else {
                showMessageModal('Install Ngrok', `Ngrok installation is not automatically supported for your operating system (${navigator.platform}). Please install Ngrok manually.`);
                showStatus('Ngrok installation is not supported for this system.', 'orange');
                // Re-enable buttons immediately for unsupported OS
                linuxButton.disabled = false;
                termuxButton.disabled = false;
                windowsButton.disabled = false;
            }
        }


        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            toggleTunnelTypeSections(); // Set initial tab visibility
            generateCommand(); // Generate command on page load
            loadExamples(); // Load examples for the Examples tab
            document.getElementById('run_ngrok_button').addEventListener('click', runNgrok);
            document.getElementById('stop_ngrok_button').addEventListener('click', stopNgrok);
            
            // New event listeners for specific installation buttons
            document.getElementById('install_ngrok_linux_button').addEventListener('click', () => handleNgrokInstallation('linux'));
            document.getElementById('install_ngrok_termux_button').addEventListener('click', () => handleNgrokInstallation('termux'));
            document.getElementById('download_ngrok_windows_button').addEventListener('click', () => handleNgrokInstallation('windows'));
        });
    </script>
</body>
</html>
