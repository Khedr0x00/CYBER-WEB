<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binwalk Web GUI</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
        }
        .tab-button.active {
            background-color: #3498DB; /* Peter River Blue */
            color: black;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Custom scrollbar for output area */
        .custom-scrollbar::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #2d3748; /* Darker track */
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4a5568; /* Lighter thumb */
            border-radius: 10px;
            border: 3px solid #2d3748; /* Padding around thumb */
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #606b7e; /* Even lighter on hover */
        }
        /* Style for the message modal */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.7); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #2d3748; /* Darker background for modal */
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 80%;
            max-width: 500px;
            text-align: center;
            position: relative;
        }
        .modal-close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-close-button:hover,
        .modal-close-button:focus {
            color: #e2e8f0;
            text-decoration: none;
            cursor: pointer;
        }
        .status-message {
            padding: 8px;
            border-radius: 4px;
            margin-top: 10px;
            font-weight: bold;
        }
        .status-message.success { background-color: #28a745; color: white; }
        .status-message.error { background-color: #dc3545; color: white; }
        .status-message.info { background-color: #007bff; color: white; }
        .status-message.warning { background-color: #ffc107; color: black; }

        /* Style for file upload input */
        input[type="file"] {
            border: 2px dashed #4a5568;
            padding: 15px;
            border-radius: 8px;
            background-color: #2d3748;
            color: #e2e8f0;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }
        input[type="file"]:hover {
            border-color: #3498DB;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col items-center p-4">
    <div class="container bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-4xl">
        <h1 class="text-4xl font-extrabold text-center text-blue-400 mb-6">Binwalk Web GUI</h1>

        <!-- Tabs -->
        <div class="flex justify-center mb-6">
            <button class="tab-button px-6 py-3 rounded-l-lg text-lg transition-colors duration-200 active" data-tab="binwalk_options">Binwalk Options</button>
            <button class="tab-button px-6 py-3 text-lg transition-colors duration-200" data-tab="file_upload">File Upload</button>
            <button class="tab-button px-6 py-3 text-lg transition-colors duration-200" data-tab="output">Output</button>
            <button class="tab-button px-6 py-3 text-lg transition-colors duration-200" data-tab="examples">Examples</button>
            <button class="tab-button px-6 py-3 rounded-r-lg text-lg transition-colors duration-200" data-tab="installation">Installation</button>
        </div>

        <!-- Tab Content -->
        <div id="binwalk_options" class="tab-content active p-4 bg-gray-700 rounded-lg mb-6">
            <h2 class="text-2xl font-bold text-blue-300 mb-4">Binwalk Command Options</h2>

            <div class="mb-4">
                <label for="target_entry" class="block text-gray-300 text-sm font-bold mb-2">Target File/URL:</label>
                <input type="text" id="target_entry" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-900 border-gray-600 text-gray-100" placeholder="e.g., firmware.bin or http://example.com/firmware.bin">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                <!-- Checkboxes -->
                <div class="flex items-center">
                    <input type="checkbox" id="signature_scan_var" class="form-checkbox h-5 w-5 text-blue-600 bg-gray-900 border-gray-600 rounded">
                    <label for="signature_scan_var" class="ml-2 text-gray-300">Signature Scan (-B)</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="entropy_analysis_var" class="form-checkbox h-5 w-5 text-blue-600 bg-gray-900 border-gray-600 rounded">
                    <label for="entropy_analysis_var" class="ml-2 text-gray-300">Entropy Analysis (-E)</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="extract_files_var" class="form-checkbox h-5 w-5 text-blue-600 bg-gray-900 border-gray-600 rounded">
                    <label for="extract_files_var" class="ml-2 text-gray-300">Extract Files (-e)</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="recursive_scan_var" class="form-checkbox h-5 w-5 text-blue-600 bg-gray-900 border-gray-600 rounded">
                    <label for="recursive_scan_var" class="ml-2 text-gray-300">Recursive Scan (-r)</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="disable_magic_var" class="form-checkbox h-5 w-5 text-blue-600 bg-gray-900 border-gray-600 rounded">
                    <label for="disable_magic_var" class="ml-2 text-gray-300">Disable Magic (-m)</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="heuristic_scan_var" class="form-checkbox h-5 w-5 text-blue-600 bg-gray-900 border-gray-600 rounded">
                    <label for="heuristic_scan_var" class="ml-2 text-gray-300">Heuristic Scan (-H)</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="verbose_output_var" class="form-checkbox h-5 w-5 text-blue-600 bg-gray-900 border-gray-600 rounded">
                    <label for="verbose_output_var" class="ml-2 text-gray-300">Verbose Output (-v)</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="quiet_output_var" class="form-checkbox h-5 w-5 text-blue-600 bg-gray-900 border-gray-600 rounded">
                    <label for="quiet_output_var" class="ml-2 text-gray-300">Quiet Output (-q)</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="no_header_var" class="form-checkbox h-5 w-5 text-blue-600 bg-gray-900 border-gray-600 rounded">
                    <label for="no_header_var" class="ml-2 text-gray-300">No Header (-N)</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="firmware_fs_scan_var" class="form-checkbox h-5 w-5 text-blue-600 bg-gray-900 border-gray-600 rounded">
                    <label for="firmware_fs_scan_var" class="ml-2 text-gray-300">Firmware FS Scan (-F)</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="executable_code_scan_var" class="form-checkbox h-5 w-5 text-blue-600 bg-gray-900 border-gray-600 rounded">
                    <label for="executable_code_scan_var" class="ml-2 text-gray-300">Executable Code Scan (-A)</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="architecture_scan_var" class="form-checkbox h-5 w-5 text-blue-600 bg-gray-900 border-gray-600 rounded">
                    <label for="architecture_scan_var" class="ml-2 text-gray-300">Architecture Scan (-a)</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="all_file_types_var" class="form-checkbox h-5 w-5 text-blue-600 bg-gray-900 border-gray-600 rounded">
                    <label for="all_file_types_var" class="ml-2 text-gray-300">All File Types (-f)</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="md5_checksum_var" class="form-checkbox h-5 w-5 text-blue-600 bg-gray-900 border-gray-600 rounded">
                    <label for="md5_checksum_var" class="ml-2 text-gray-300">MD5 Checksum (-L)</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="sha1_checksum_var" class="form-checkbox h-5 w-5 text-blue-600 bg-gray-900 border-gray-600 rounded">
                    <label for="sha1_checksum_var" class="ml-2 text-gray-300">SHA1 Checksum (-K)</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="sha256_checksum_var" class="form-checkbox h-5 w-5 text-blue-600 bg-gray-900 border-gray-600 rounded">
                    <label for="sha256_checksum_var" class="ml-2 text-gray-300">SHA256 Checksum (-J)</label>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <!-- Text Inputs for specific values -->
                <div>
                    <label for="custom_signatures_file_entry" class="block text-gray-300 text-sm font-bold mb-2">Custom Signatures File (--custom):</label>
                    <input type="text" id="custom_signatures_file_entry" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-900 border-gray-600 text-gray-100" placeholder="e.g., /path/to/signatures.txt">
                </div>
                <div>
                    <label for="offset_entry" class="block text-gray-300 text-sm font-bold mb-2">Offset (-o):</label>
                    <input type="number" id="offset_entry" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-900 border-gray-600 text-gray-100" placeholder="e.g., 1024">
                </div>
                <div>
                    <label for="length_entry" class="block text-gray-300 text-sm font-bold mb-2">Length (-l):</label>
                    <input type="number" id="length_entry" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-900 border-gray-600 text-gray-100" placeholder="e.g., 2048">
                </div>
                <div>
                    <label for="block_size_entry" class="block text-gray-300 text-sm font-bold mb-2">Block Size (-k):</label>
                    <input type="number" id="block_size_entry" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-900 border-gray-600 text-gray-100" placeholder="e.g., 512">
                </div>
                <div>
                    <label for="raw_search_entry" class="block text-gray-300 text-sm font-bold mb-2">Raw Search (-R):</label>
                    <input type="text" id="raw_search_entry" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-900 border-gray-600 text-gray-100" placeholder="e.g., 'MZ'">
                </div>
                <div>
                    <label for="word_list_entry" class="block text-gray-300 text-sm font-bold mb-2">Word List (--wordlist):</label>
                    <input type="text" id="word_list_entry" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-900 border-gray-600 text-gray-100" placeholder="e.g., /usr/share/wordlists/rockyou.txt">
                </div>
                <div>
                    <label for="output_file_entry" class="block text-gray-300 text-sm font-bold mb-2">Output File (-o):</label>
                    <input type="text" id="output_file_entry" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-900 border-gray-600 text-gray-100" placeholder="e.g., binwalk_results.txt">
                </div>
                <div>
                    <label for="log_file_entry" class="block text-gray-300 text-sm font-bold mb-2">Log File (-L):</label>
                    <input type="text" id="log_file_entry" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-900 border-gray-600 text-gray-100" placeholder="e.g., binwalk.log">
                </div>
                <div>
                    <label for="disassembler_dropdown" class="block text-gray-300 text-sm font-bold mb-2">Disassembler (--disasm):</label>
                    <select id="disassembler_dropdown" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-900 border-gray-600 text-gray-100">
                        <option value="">None</option>
                        <option value="arm">ARM</option>
                        <option value="mips">MIPS</option>
                        <option value="x86">x86</option>
                        <option value="all">All</option>
                    </select>
                </div>
            </div>

            <div class="mt-6">
                <label for="generated_command" class="block text-gray-300 text-sm font-bold mb-2">Generated Command:</label>
                <pre id="generated_command" class="bg-gray-900 text-green-400 p-4 rounded-md overflow-auto text-sm custom-scrollbar">binwalk</pre>
            </div>

            <div class="flex justify-center mt-6 space-x-4">
                <button id="generate_command_button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                    Generate Command
                </button>
                <button id="run_binwalk_button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                    Run Binwalk
                </button>
            </div>
        </div>

        <div id="file_upload" class="tab-content p-4 bg-gray-700 rounded-lg mb-6">
            <h2 class="text-2xl font-bold text-blue-300 mb-4">Upload Target File</h2>
            <div class="mb-4">
                <label for="file_input" class="block text-gray-300 text-sm font-bold mb-2">Select a file to upload:</label>
                <input type="file" id="file_input" class="block w-full text-sm text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
            </div>
            <div class="flex justify-center mt-6">
                <button id="upload_file_button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                    Upload File
                </button>
            </div>
            <p id="upload_status" class="text-center text-sm mt-4"></p>
        </div>

        <div id="output" class="tab-content p-4 bg-gray-700 rounded-lg mb-6">
            <h2 class="text-2xl font-bold text-blue-300 mb-4">Binwalk Output</h2>
            <div class="relative">
                <pre id="binwalk_output_area" class="bg-gray-900 text-gray-200 p-4 rounded-md h-96 overflow-auto text-sm custom-scrollbar"></pre>
                <div id="loading_indicator" class="absolute inset-0 flex items-center justify-center bg-gray-900 bg-opacity-75 rounded-md hidden">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
                    <p class="text-white text-lg ml-4">Running Binwalk...</p>
                </div>
            </div>
        </div>

        <div id="examples" class="tab-content p-4 bg-gray-700 rounded-lg mb-6">
            <h2 class="text-2xl font-bold text-blue-300 mb-4">Binwalk Examples</h2>
            <div id="examples_list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Examples will be loaded here by JavaScript -->
                <p class="text-gray-400">Loading examples...</p>
            </div>
        </div>

        <div id="installation" class="tab-content p-4 bg-gray-700 rounded-lg mb-6">
            <h2 class="text-2xl font-bold text-blue-300 mb-4">Binwalk Installation</h2>
            <p class="text-gray-300 mb-4">Binwalk is a powerful tool for analyzing, reverse engineering, and extracting firmware images. To use this web GUI, Binwalk must be installed on the server where the Python backend is running.</p>

            <div class="bg-gray-800 p-4 rounded-md mb-4">
                <h3 class="text-xl font-semibold text-blue-200 mb-2">Web GUI Setup (Prerequisites for the Python Backend):</h3>
                <ul class="list-disc list-inside text-gray-300 space-y-1">
                    <li>Ensure Python 3 is installed.</li>
                    <li>Install Flask: <code class="bg-gray-900 p-1 rounded">pip install Flask</code></li>
                    <li>Install `python-magic` (for file type detection, often a dependency for binwalk's Python bindings): <code class="bg-gray-900 p-1 rounded">pip install python-magic</code></li>
                    <li>Ensure `shutil` and `subprocess` are available (standard Python libraries).</li>
                    <li>Place `app.py`, `index.html`, and `binwalk_examples.txt` in the same directory.</li>
                    <li>Run the Flask app: <code class="bg-gray-900 p-1 rounded">python app.py</code> (or via your PHP dashboard setup).</li>
                </ul>
            </div>

            <div class="bg-gray-800 p-4 rounded-md mb-4">
                <h3 class="text-xl font-semibold text-blue-200 mb-2">Binwalk Tool Installation:</h3>
                <p class="text-gray-300 mb-2">Select your operating system for installation instructions or automatic installation:</p>
                <div class="flex flex-wrap gap-4 mb-4">
                    <button id="install_binwalk_linux_button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-300 ease-in-out transform hover:scale-105">
                        <i data-lucide="linux" class="inline-block mr-2"></i> Install on Linux (APT)
                    </button>
                    <button id="install_binwalk_termux_button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-300 ease-in-out transform hover:scale-105">
                        <i data-lucide="terminal" class="inline-block mr-2"></i> Install on Termux (PKG)
                    </button>
                    <button id="download_binwalk_windows_button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-300 ease-in-out transform hover:scale-105">
                        <i data-lucide="windows" class="inline-block mr-2"></i> Windows (Manual)
                    </button>
                    <button id="install_binwalk_macos_button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-300 ease-in-out transform hover:scale-105">
                        <i data-lucide="apple" class="inline-block mr-2"></i> macOS (Homebrew)
                    </button>
                </div>
                <div id="installation_status" class="mt-4 p-3 rounded-md text-sm custom-scrollbar h-48 overflow-auto bg-gray-900 text-gray-200">
                    <p>Click an installation button above to see instructions or start automatic installation.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Modal -->
    <div id="message_modal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button" onclick="document.getElementById('message_modal').style.display='none';">&times;</span>
            <h3 id="modal_title" class="text-xl font-bold text-blue-300 mb-3"></h3>
            <p id="modal_message" class="text-gray-200 mb-4"></p>
            <button onclick="document.getElementById('message_modal').style.display='none';" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-300 ease-in-out">Close</button>
        </div>
    </div>

    <script>
        // Initialize Lucide Icons
        lucide.createIcons();

        // Utility function to show a modal message
        function showMessageModal(title, message) {
            document.getElementById('modal_title').innerText = title;
            document.getElementById('modal_message').innerText = message;
            document.getElementById('message_modal').style.display = 'flex';
        }

        // Utility function to show status messages in the installation tab
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('installation_status');
            statusDiv.innerHTML = `<p class="status-message ${type}">${message}</p>`;
            statusDiv.scrollTop = statusDiv.scrollHeight; // Scroll to bottom
        }

        // Function to switch tabs
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
                button.classList.add('bg-gray-700', 'hover:bg-gray-600', 'text-gray-300');
                button.classList.remove('bg-blue-600', 'text-black', 'font-bold');
            });

            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');
            document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.remove('bg-gray-700', 'hover:bg-gray-600', 'text-gray-300');
            document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('bg-blue-600', 'text-black', 'font-bold');

            // If switching to output tab, ensure loading indicator is hidden initially
            if (tabId === 'output') {
                document.getElementById('loading_indicator').classList.add('hidden');
            }
        }

        // Function to generate the binwalk command string
        function generateCommand() {
            let commandParts = ['binwalk'];
            const target = document.getElementById('target_entry').value.trim();

            // Checkboxes
            if (document.getElementById('signature_scan_var').checked) commandParts.push('-B');
            if (document.getElementById('entropy_analysis_var').checked) commandParts.push('-E');
            if (document.getElementById('extract_files_var').checked) commandParts.push('-e');
            if (document.getElementById('recursive_scan_var').checked) commandParts.push('-r');
            if (document.getElementById('disable_magic_var').checked) commandParts.push('-m');
            if (document.getElementById('heuristic_scan_var').checked) commandParts.push('-H');
            if (document.getElementById('verbose_output_var').checked) commandParts.push('-v');
            if (document.getElementById('quiet_output_var').checked) commandParts.push('-q');
            if (document.getElementById('no_header_var').checked) commandParts.push('-N');
            if (document.getElementById('firmware_fs_scan_var').checked) commandParts.push('-F');
            if (document.getElementById('executable_code_scan_var').checked) commandParts.push('-A');
            if (document.getElementById('architecture_scan_var').checked) commandParts.push('-a');
            if (document.getElementById('all_file_types_var').checked) commandParts.push('-f');
            if (document.getElementById('md5_checksum_var').checked) commandParts.push('-L');
            if (document.getElementById('sha1_checksum_var').checked) commandParts.push('-K');
            if (document.getElementById('sha256_checksum_var').checked) commandParts.push('-J');

            // Text Inputs
            const customSignaturesFile = document.getElementById('custom_signatures_file_entry').value.trim();
            if (customSignaturesFile) commandParts.push(`--custom="${customSignaturesFile}"`);

            const offset = document.getElementById('offset_entry').value.trim();
            if (offset) commandParts.push(`-o ${offset}`);

            const length = document.getElementById('length_entry').value.trim();
            if (length) commandParts.push(`-l ${length}`);

            const blockSize = document.getElementById('block_size_entry').value.trim();
            if (blockSize) commandParts.push(`-k ${blockSize}`);

            const rawSearch = document.getElementById('raw_search_entry').value.trim();
            if (rawSearch) commandParts.push(`-R "${rawSearch}"`);

            const wordList = document.getElementById('word_list_entry').value.trim();
            if (wordList) commandParts.push(`--wordlist="${wordList}"`);

            const outputFile = document.getElementById('output_file_entry').value.trim();
            if (outputFile) commandParts.push(`-o "${outputFile}"`);

            const logFile = document.getElementById('log_file_entry').value.trim();
            if (logFile) commandParts.push(`-L "${logFile}"`);

            // Dropdowns
            const disassembler = document.getElementById('disassembler_dropdown').value;
            if (disassembler) commandParts.push(`--disasm=${disassembler}`);

            // Add target at the end if it exists
            if (target) {
                commandParts.push(`"${target}"`);
            } else {
                // If no target, remove the placeholder 'binwalk' to show just the command name
                if (commandParts.length === 1 && commandParts[0] === 'binwalk') {
                    commandParts = ['binwalk']; // Keep just 'binwalk' if no options/target
                }
            }

            document.getElementById('generated_command').innerText = commandParts.join(' ');
        }

        // Function to run Binwalk
        async function runBinwalk() {
            const target = document.getElementById('target_entry').value.trim();
            const generatedCommandText = document.getElementById('generated_command').innerText;

            if (!target) {
                showMessageModal('Error', 'Please specify a target file or URL before running Binwalk.');
                return;
            }

            // Extract options from the generated command string, excluding 'binwalk' and the target
            const commandParts = generatedCommandText.split(' ').filter(part => part !== 'binwalk' && part !== `"${target}"`);
            const options = commandParts.map(part => part.replace(/"/g, '')); // Remove quotes for sending to backend

            document.getElementById('binwalk_output_area').innerText = ''; // Clear previous output
            document.getElementById('loading_indicator').classList.remove('hidden'); // Show loading indicator
            switchTab('output'); // Switch to output tab

            try {
                const response = await fetch('/run_binwalk', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ target: target, options: options })
                });
                const result = await response.json();

                if (response.ok) {
                    const scanId = result.scan_id;
                    const eventSource = new EventSource(`/stream_output/${scanId}`);
                    eventSource.onmessage = function(event) {
                        const data = JSON.parse(event.data);
                        if (data.output === "---END_OF_STREAM---") {
                            eventSource.close();
                            document.getElementById('loading_indicator').classList.add('hidden'); // Hide loading indicator
                        } else {
                            document.getElementById('binwalk_output_area').innerText += data.output;
                            document.getElementById('binwalk_output_area').scrollTop = document.getElementById('binwalk_output_area').scrollHeight; // Scroll to bottom
                        }
                    };
                    eventSource.onerror = function(err) {
                        console.error("EventSource failed:", err);
                        eventSource.close();
                        document.getElementById('loading_indicator').classList.add('hidden'); // Hide loading indicator
                        showMessageModal('Error', 'Failed to stream Binwalk output. Check server logs.');
                    };
                } else {
                    document.getElementById('loading_indicator').classList.add('hidden'); // Hide loading indicator
                    showMessageModal('Error', `Failed to start Binwalk scan: ${result.message}`);
                }
            } catch (error) {
                console.error('Error running Binwalk:', error);
                document.getElementById('loading_indicator').classList.add('hidden'); // Hide loading indicator
                showMessageModal('Error', 'An error occurred while trying to run Binwalk.');
            }
        }

        // Function to handle file upload
        async function uploadFile() {
            const fileInput = document.getElementById('file_input');
            const uploadStatus = document.getElementById('upload_status');
            const file = fileInput.files[0];

            if (!file) {
                uploadStatus.innerText = 'Please select a file first.';
                uploadStatus.style.color = 'orange';
                return;
            }

            uploadStatus.innerText = 'Uploading...';
            uploadStatus.style.color = 'white';

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (response.ok) {
                    uploadStatus.innerText = `Success: ${result.message}. File path: ${result.filepath}`;
                    uploadStatus.style.color = 'lightgreen';
                    document.getElementById('target_entry').value = result.filepath; // Set uploaded file as target
                    showMessageModal('Upload Successful', `File uploaded to: ${result.filepath}. It has been set as your target.`);
                    generateCommand(); // Update command with new target
                } else {
                    uploadStatus.innerText = `Error: ${result.message}`;
                    uploadStatus.style.color = 'red';
                    showMessageModal('Upload Failed', `Error: ${result.message}`);
                }
            } catch (error) {
                console.error('Error uploading file:', error);
                uploadStatus.innerText = 'An error occurred during upload.';
                uploadStatus.style.color = 'red';
                showMessageModal('Upload Error', 'An error occurred while trying to upload the file.');
            }
        }

        // Function to load examples
        async function loadExamples() {
            try {
                const response = await fetch('/get_examples');
                const examples = await response.json();
                const examplesListDiv = document.getElementById('examples_list');
                examplesListDiv.innerHTML = ''; // Clear loading message

                if (examples.length === 0) {
                    examplesListDiv.innerHTML = '<p class="text-gray-400">No examples found.</p>';
                    return;
                }

                examples.forEach(example => {
                    const exampleDiv = document.createElement('div');
                    exampleDiv.className = 'bg-gray-800 p-4 rounded-lg shadow-md';
                    exampleDiv.innerHTML = `
                        <h3 class="text-xl font-semibold text-blue-300 mb-2">${example.name}</h3>
                        <p class="text-gray-400 text-sm mb-3">${example.description}</p>
                        <button class="load-example-button bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-3 rounded-md text-sm transition duration-300 ease-in-out" data-options='${JSON.stringify(example.options)}' data-target='${example.options.target_entry || ""}'>Load Example</button>
                        <div class="mt-3">
                            <h4 class="text-md font-semibold text-gray-300">Example Command:</h4>
                            <pre class="bg-gray-900 text-green-400 p-2 rounded-md overflow-auto text-xs custom-scrollbar">${example.example_command || 'Not available'}</pre>
                        </div>
                        <div class="mt-3">
                            <h4 class="text-md font-semibold text-gray-300">Example Output:</h4>
                            <pre class="bg-gray-900 text-gray-200 p-2 rounded-md h-32 overflow-auto text-xs custom-scrollbar">${example.example_output || 'Not available'}</pre>
                        </div>
                    `;
                    examplesListDiv.appendChild(exampleDiv);
                });

                // Add event listeners to load example buttons
                document.querySelectorAll('.load-example-button').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const options = JSON.parse(event.target.dataset.options);
                        const target = event.target.dataset.target;

                        // Clear all form fields first
                        document.getElementById('target_entry').value = '';
                        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => checkbox.checked = false);
                        document.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => input.value = '');
                        document.querySelectorAll('select').forEach(select => select.value = '');

                        // Set target
                        document.getElementById('target_entry').value = target;

                        // Set options
                        for (const key in options) {
                            const element = document.getElementById(key);
                            if (element) {
                                if (element.type === 'checkbox') {
                                    element.checked = options[key];
                                } else {
                                    element.value = options[key];
                                }
                            }
                        }
                        generateCommand(); // Update generated command
                        switchTab('binwalk_options'); // Switch back to options tab
                        showMessageModal('Example Loaded', `Options for "${event.target.closest('.bg-gray-800').querySelector('h3').innerText}" have been loaded.`);
                    });
                });

            } catch (error) {
                console.error('Error loading examples:', error);
                document.getElementById('examples_list').innerHTML = '<p class="text-red-400">Failed to load examples. Please check server logs.</p>';
            }
        }

        // Function to handle Nmap installation
        async function handleBinwalkInstallation(installType) {
            const linuxButton = document.getElementById('install_binwalk_linux_button');
            const termuxButton = document.getElementById('install_binwalk_termux_button');
            const windowsButton = document.getElementById('download_binwalk_windows_button');
            const macosButton = document.getElementById('install_binwalk_macos_button');

            // Disable all installation buttons during operation
            linuxButton.disabled = true;
            termuxButton.disabled = true;
            windowsButton.disabled = true;
            macosButton.disabled = true;

            showStatus('Initiating installation...', 'info');

            try {
                const response = await fetch('/install_binwalk', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ install_type: installType })
                });
                const result = await response.json();

                if (response.ok) {
                    showStatus(result.message, 'success');
                    showMessageModal('Installation Status', result.message);
                } else {
                    showStatus(`Error: ${result.message}`, 'error');
                    showMessageModal('Installation Failed', result.message);
                }
            } catch (error) {
                console.error('Error during installation:', error);
                showStatus('An error occurred during installation attempt.', 'error');
                showMessageModal('Installation Error', 'An error occurred while trying to install Binwalk.');
            } finally {
                // Re-enable buttons after operation
                linuxButton.disabled = false;
                termuxButton.disabled = false;
                windowsButton.disabled = false;
                macosButton.disabled = false;
            }
        }

        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            generateCommand(); // Generate command on page load (shows "binwalk" initially)
            loadExamples(); // Load examples for the Examples tab

            // Event listeners for buttons
            document.getElementById('generate_command_button').addEventListener('click', generateCommand);
            document.getElementById('run_binwalk_button').addEventListener('click', runBinwalk);
            document.getElementById('upload_file_button').addEventListener('click', uploadFile);

            // Event listeners for tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    switchTab(button.dataset.tab);
                });
            });

            // Event listeners for installation buttons
            document.getElementById('install_binwalk_linux_button').addEventListener('click', () => handleBinwalkInstallation('linux'));
            document.getElementById('install_binwalk_termux_button').addEventListener('click', () => handleBinwalkInstallation('termux'));
            document.getElementById('download_binwalk_windows_button').addEventListener('click', () => handleBinwalkInstallation('windows'));
            document.getElementById('install_binwalk_macos_button').addEventListener('click', () => handleBinwalkInstallation('macos'));

            // Add event listeners to all input fields, checkboxes, and dropdowns to update command dynamically
            document.querySelectorAll('#binwalk_options input, #binwalk_options select').forEach(element => {
                element.addEventListener('input', generateCommand);
                element.addEventListener('change', generateCommand); // For checkboxes and selects
            });

            // Check if binwalk is installed on page load
            checkBinwalkInstalled();
        });

        async function checkBinwalkInstalled() {
            try {
                const response = await fetch('/check_binwalk_installed');
                const result = await response.json();
                if (result.installed) {
                    showStatus(`Binwalk is installed at: ${result.path}`, 'success');
                } else {
                    showStatus('Binwalk is not detected. Please install it using the options above.', 'warning');
                }
            } catch (error) {
                console.error('Error checking binwalk installation status:', error);
                showStatus('Could not check Binwalk installation status.', 'error');
            }
        }
    </script>
</body>
</html>
